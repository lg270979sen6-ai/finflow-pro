<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FinFlow ¬∑ –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<style>
:root {
  --bg:#0d0f14; --s1:#161a22; --s2:#1e2330; --s3:#252d3d;
  --border:rgba(255,255,255,0.08); --border2:rgba(255,255,255,0.14);
  --text:#fff; --text2:#a0aabb; --text3:#5a6478;
  --accent:#6c8dfa; --red:#ff6b6b; --green:#4ecca3; --orange:#ffa94d;
  --purple:#b197fc; --pink:#ff87b2;
}
*{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;background:var(--bg);font-family:'DM Sans',sans-serif;color:var(--text);}
body{display:flex;flex-direction:column;min-height:100vh;}

/* ‚îÄ‚îÄ LOGIN SCREEN ‚îÄ‚îÄ */
.login-screen{position:fixed;inset:0;background:var(--bg);z-index:999;display:flex;align-items:center;justify-content:center;padding:24px;}
.login-card{background:var(--s1);border:1px solid var(--border2);border-radius:24px;padding:40px 36px;width:100%;max-width:380px;}
.login-logo{display:flex;align-items:center;gap:10px;margin-bottom:6px;}
.login-logo-dot{width:9px;height:9px;border-radius:50%;background:var(--accent);}
.login-logo-text{font-family:'Syne',sans-serif;font-weight:800;font-size:24px;}
.login-sub{font-size:12px;color:var(--text3);letter-spacing:.12em;text-transform:uppercase;margin-bottom:32px;}
.login-label{font-size:11px;color:var(--text3);font-weight:600;letter-spacing:.08em;text-transform:uppercase;margin-bottom:6px;}
.login-input{width:100%;padding:13px 16px;background:var(--s2);border:1.5px solid var(--border);border-radius:12px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:15px;outline:none;transition:border-color .2s;margin-bottom:16px;}
.login-input:focus{border-color:var(--accent);}
.login-btn{width:100%;padding:14px;border-radius:12px;background:var(--accent);color:#fff;border:none;font-family:'DM Sans',sans-serif;font-size:15px;font-weight:600;cursor:pointer;transition:all .15s;box-shadow:0 4px 20px rgba(108,141,250,.35);}
.login-btn:hover{background:#7d9dfb;transform:translateY(-1px);}
.login-err{font-size:12px;color:var(--red);text-align:center;margin-top:10px;min-height:16px;}
.glow{position:absolute;top:-30%;left:50%;transform:translateX(-50%);width:500px;height:500px;background:radial-gradient(ellipse,rgba(108,141,250,.1) 0%,transparent 70%);pointer-events:none;}

/* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
.topbar{display:flex;align-items:center;justify-content:space-between;padding:16px 28px;background:var(--s1);border-bottom:1px solid var(--border);flex-shrink:0;}
.topbar-logo{display:flex;align-items:center;gap:8px;}
.topbar-dot{width:8px;height:8px;border-radius:50%;background:var(--accent);}
.topbar-title{font-family:'Syne',sans-serif;font-weight:800;font-size:18px;}
.topbar-badge{background:rgba(108,141,250,.15);color:var(--accent);font-size:10px;font-weight:700;padding:3px 8px;border-radius:6px;letter-spacing:.08em;text-transform:uppercase;}
.topbar-right{display:flex;align-items:center;gap:12px;}
.sync-dot{width:7px;height:7px;border-radius:50%;background:var(--green);}
.sync-dot.offline{background:var(--red);}
.sync-text{font-size:12px;color:var(--text3);}
.logout-btn{padding:7px 14px;border-radius:8px;background:var(--s2);border:1px solid var(--border);color:var(--text2);font-size:12px;cursor:pointer;transition:all .15s;}
.logout-btn:hover{border-color:var(--border2);color:var(--text);}

.main{flex:1;padding:28px;overflow-y:auto;max-width:1100px;width:100%;margin:0 auto;}

/* ‚îÄ‚îÄ SECTION ‚îÄ‚îÄ */
.section-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;}
.section-title{font-family:'Syne',sans-serif;font-weight:700;font-size:18px;}
.section-sub{font-size:12px;color:var(--text3);margin-top:2px;}
.btn{padding:9px 18px;border-radius:10px;border:none;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all .15s;display:inline-flex;align-items:center;gap:6px;}
.btn-primary{background:var(--accent);color:#fff;box-shadow:0 3px 14px rgba(108,141,250,.3);}
.btn-primary:hover{background:#7d9dfb;transform:translateY(-1px);}
.btn-danger{background:rgba(255,107,107,.12);color:var(--red);border:1px solid rgba(255,107,107,.2);}
.btn-danger:hover{background:rgba(255,107,107,.2);}
.btn-secondary{background:var(--s2);color:var(--text2);border:1px solid var(--border);}
.btn-secondary:hover{border-color:var(--border2);color:var(--text);}
.btn-sm{padding:6px 12px;font-size:12px;border-radius:8px;}

/* ‚îÄ‚îÄ ACCOUNTS GRID ‚îÄ‚îÄ */
.accounts-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px;margin-bottom:40px;}
.account-card{background:var(--s1);border:1px solid var(--border);border-radius:20px;padding:20px;transition:border-color .2s;}
.account-card:hover{border-color:var(--border2);}
.account-card-header{display:flex;align-items:center;gap:12px;margin-bottom:16px;}
.account-icon{width:44px;height:44px;border-radius:13px;display:flex;align-items:center;justify-content:center;font-family:'Syne',sans-serif;font-weight:800;font-size:18px;color:#fff;flex-shrink:0;}
.account-name{font-family:'Syne',sans-serif;font-weight:700;font-size:16px;}
.account-room{font-size:11px;color:var(--text3);margin-top:2px;font-family:monospace;}
.account-actions{display:flex;gap:6px;margin-left:auto;}

/* ‚îÄ‚îÄ USERS TABLE ‚îÄ‚îÄ */
.users-list{display:flex;flex-direction:column;gap:8px;margin-top:12px;}
.user-row{display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--s2);border-radius:12px;}
.user-avatar{width:32px;height:32px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-family:'Syne',sans-serif;font-weight:800;font-size:13px;color:#fff;flex-shrink:0;}
.user-name{font-size:14px;font-weight:500;flex:1;}
.user-login{font-size:11px;color:var(--text3);font-family:monospace;}
.role-badge{padding:3px 8px;border-radius:6px;font-size:11px;font-weight:600;letter-spacing:.04em;}
.role-admin{background:rgba(108,141,250,.15);color:var(--accent);}
.role-editor{background:rgba(78,204,163,.12);color:var(--green);}
.role-viewer{background:rgba(90,100,120,.2);color:var(--text3);}
.add-user-row{display:flex;align-items:center;gap:8px;padding:8px 12px;border:1.5px dashed var(--border);border-radius:12px;cursor:pointer;transition:all .2s;color:var(--text3);font-size:13px;}
.add-user-row:hover{border-color:var(--accent);color:var(--accent);}

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:500;display:none;align-items:center;justify-content:center;padding:24px;backdrop-filter:blur(4px);}
.modal-overlay.open{display:flex;}
.modal{background:var(--s1);border:1px solid var(--border2);border-radius:20px;padding:28px;width:100%;max-width:400px;}
.modal-title{font-family:'Syne',sans-serif;font-weight:700;font-size:18px;margin-bottom:6px;}
.modal-sub{font-size:13px;color:var(--text3);margin-bottom:24px;}
.form-group{margin-bottom:16px;}
.form-label{font-size:11px;color:var(--text3);font-weight:600;letter-spacing:.08em;text-transform:uppercase;margin-bottom:6px;display:block;}
.form-input{width:100%;padding:12px 14px;background:var(--s2);border:1.5px solid var(--border);border-radius:11px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:14px;outline:none;transition:border-color .2s;}
.form-input:focus{border-color:var(--accent);}
.form-row{display:flex;gap:10px;}
.form-row .form-group{flex:1;}
.role-select{width:100%;padding:12px 14px;background:var(--s2);border:1.5px solid var(--border);border-radius:11px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:14px;outline:none;cursor:pointer;}
.modal-footer{display:flex;gap:8px;justify-content:flex-end;margin-top:24px;}
.color-picker-row{display:flex;gap:8px;flex-wrap:wrap;}
.color-dot{width:28px;height:28px;border-radius:8px;cursor:pointer;border:2px solid transparent;transition:all .15s;}
.color-dot.selected{border-color:#fff;transform:scale(1.15);}

/* ‚îÄ‚îÄ STATS BAR ‚îÄ‚îÄ */
.stats-bar{display:flex;gap:16px;margin-bottom:32px;flex-wrap:wrap;}
.stat-card{background:var(--s1);border:1px solid var(--border);border-radius:16px;padding:16px 20px;flex:1;min-width:140px;}
.stat-num{font-family:'Syne',sans-serif;font-weight:800;font-size:28px;}
.stat-label{font-size:12px;color:var(--text3);margin-top:2px;}

/* ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ */
.empty{text-align:center;padding:40px 20px;color:var(--text3);}
.empty-icon{font-size:40px;margin-bottom:12px;}
.empty-text{font-size:14px;}

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
.toast{position:fixed;top:20px;left:50%;transform:translateX(-50%) translateY(-80px);background:var(--s1);border:1px solid var(--border2);border-radius:12px;padding:10px 20px;font-size:13px;font-weight:500;transition:transform .3s;z-index:9999;white-space:nowrap;}
.toast.show{transform:translateX(-50%) translateY(0);}

@keyframes fadeIn{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:none}}
.fade-in{animation:fadeIn .4s ease both;}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen" class="login-screen">
  <div class="glow"></div>
  <div class="login-card fade-in">
    <div class="login-logo"><div class="login-logo-dot"></div><div class="login-logo-text">FinFlow</div></div>
    <div class="login-sub">–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</div>
    <div style="font-size:11px;color:#5a6478;margin-bottom:20px;background:#1e2330;border-radius:8px;padding:8px 12px;">
      üîê –ü–µ—Ä–≤—ã–π –≤—Ö–æ–¥: –ø–∞—Ä–æ–ª—å <b style="color:#a0aabb;">setup1234</b><br>
      –°–º–µ–Ω–∏—Ç–µ –µ–≥–æ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞
    </div>
    <div class="login-label">–ú–∞—Å—Ç–µ—Ä-–ø–∞—Ä–æ–ª—å</div>
    <input id="masterInput" class="login-input" type="password" placeholder="–í–≤–µ–¥–∏—Ç–µ –º–∞—Å—Ç–µ—Ä-–ø–∞—Ä–æ–ª—å"
      onkeydown="if(event.key==='Enter')adminLogin()">
    <button class="login-btn" onclick="adminLogin()">–í–æ–π—Ç–∏ –≤ –ø–∞–Ω–µ–ª—å</button>
    <div id="loginErr" class="login-err"></div>
  </div>
</div>

<!-- APP -->
<div id="adminApp" style="display:none;flex-direction:column;height:100vh;">

  <!-- Topbar -->
  <div class="topbar">
    <div class="topbar-logo">
      <div class="topbar-dot"></div>
      <div class="topbar-title">FinFlow</div>
      <div class="topbar-badge">Superadmin</div>
    </div>
    <div class="topbar-right">
      <div class="sync-dot" id="syncDot"></div>
      <div class="sync-text" id="syncText">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>
      <button class="logout-btn" onclick="adminLogout()">–í—ã–π—Ç–∏</button>
    </div>
  </div>

  <div class="main">

    <!-- System settings -->
    <div id="systemSection" style="background:var(--s1);border:1px solid var(--border);border-radius:20px;padding:20px 24px;margin-bottom:28px;">
      <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:gap;">
        <div>
          <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:15px;margin-bottom:3px;">‚öôÔ∏è –°–∏—Å—Ç–µ–º–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</div>
          <div style="font-size:12px;color:var(--text3);">–ú–∞—Å—Ç–µ—Ä-–ø–∞—Ä–æ–ª—å —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ Firebase ‚Äî –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç</div>
        </div>
        <button class="btn btn-secondary" style="margin-top:8px;" onclick="openChangeMasterPass()">üîë –ò–∑–º–µ–Ω–∏—Ç—å –º–∞—Å—Ç–µ—Ä-–ø–∞—Ä–æ–ª—å</button>
      </div>
    </div>

    <!-- Stats -->
    <div class="stats-bar" id="statsBar">
      <div class="stat-card"><div class="stat-num" id="statAccounts">‚Äî</div><div class="stat-label">–ê–∫–∫–∞—É–Ω—Ç–æ–≤</div></div>
      <div class="stat-card"><div class="stat-num" id="statUsers">‚Äî</div><div class="stat-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div></div>
      <div class="stat-card"><div class="stat-num" id="statAdmins">‚Äî</div><div class="stat-label">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤</div></div>
    </div>

    <!-- Accounts -->
    <div class="section-header">
      <div>
        <div class="section-title">–ê–∫–∫–∞—É–Ω—Ç—ã</div>
        <div class="section-sub">–ö–∞–∂–¥—ã–π –∞–∫–∫–∞—É–Ω—Ç ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–π –±—é–¥–∂–µ—Ç —Å –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏</div>
      </div>
      <button class="btn btn-primary" onclick="openCreateAccount()">Ôºã –ù–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç</button>
    </div>
    <div style="margin-bottom:16px;display:flex;gap:10px;flex-wrap:wrap;">
      <button class="btn btn-secondary" onclick="resetAllAccountsCategories()" style="font-size:13px">üîÑ –°–∫–∏–Ω—É—Ç–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó –≤—Å—ñ—Ö –∞–∫–∞—É–Ω—Ç—ñ–≤</button>
    </div>
    <div class="accounts-grid" id="accountsGrid">
      <div class="empty"><div class="empty-icon">üìÇ</div><div class="empty-text">–ó–∞–≥—Ä—É–∑–∫–∞...</div></div>
    </div>

  </div>
</div>

<!-- MODAL: Create Account -->
<div class="modal-overlay" id="modalAccount">
  <div class="modal">
    <div class="modal-title" id="modalAccountTitle">–ù–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç</div>
    <div class="modal-sub">–ê–∫–∫–∞—É–Ω—Ç ‚Äî —ç—Ç–æ –æ—Ç–¥–µ–ª—å–Ω—ã–π –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –±—é–¥–∂–µ—Ç</div>
    <div class="form-group">
      <label class="form-label">ID –∞–∫–∫–∞—É–Ω—Ç–∞ (–ª–∞—Ç–∏–Ω–∏—Ü–∞, –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤)</label>
      <input class="form-input" id="accId" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: family-bogdan" oninput="this.value=this.value.toLowerCase().replace(/[^a-z0-9-]/g,'')">
    </div>
    <div class="form-group">
      <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞</label>
      <input class="form-input" id="accName" placeholder="–°–µ–º—å—è –ë–æ–≥–¥–∞–Ω–∞">
    </div>
    <div class="form-group">
      <label class="form-label">–¶–≤–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞</label>
      <div class="color-picker-row" id="accColorPicker"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modalAccount')">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-primary" onclick="saveAccount()">–°–æ–∑–¥–∞—Ç—å</button>
    </div>
  </div>
</div>

<!-- MODAL: Add/Edit User -->
<div class="modal-overlay" id="modalUser">
  <div class="modal">
    <div class="modal-title" id="modalUserTitle">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
    <div class="modal-sub" id="modalUserSub">–í –∞–∫–∫–∞—É–Ω—Ç</div>
    <div class="form-group">
      <label class="form-label">–ò–º—è</label>
      <input class="form-input" id="userName" placeholder="–ë–æ–≥–¥–∞–Ω">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">–õ–æ–≥–∏–Ω</label>
        <input class="form-input" id="userLogin" placeholder="bogdan" oninput="this.value=this.value.toLowerCase().replace(/[^a-z0-9_]/g,'')">
      </div>
      <div class="form-group">
        <label class="form-label">–ü–∞—Ä–æ–ª—å</label>
        <input class="form-input" id="userPassword" placeholder="–º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞">
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">–†–æ–ª—å</label>
      <select class="role-select" id="userRole">
        <option value="admin">üîë –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä ‚Äî –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø + —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</option>
        <option value="editor">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–æ—Ä ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–æ–≤</option>
        <option value="viewer">üëÅ –ß–∏—Ç–∞—Ç–µ–ª—å ‚Äî —Ç–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä</option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">–¶–≤–µ—Ç –∞–≤–∞—Ç–∞—Ä–∞</label>
      <div class="color-picker-row" id="userColorPicker"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modalUser')">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-primary" id="saveUserBtn" onclick="saveUser()">–î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const FB_CONFIG = {
  apiKey: "AIzaSyBZ1b6yf1WQbhZ7lhIbeYw_fKc4k88mmFc",
  authDomain: "family-budget-32149.firebaseapp.com",
  databaseURL: "https://family-budget-32149-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "family-budget-32149",
  storageBucket: "family-budget-32149.firebasestorage.app",
  messagingSenderId: "1015461302295",
  appId: "1:1015461302295:web:835d7a14a852c224534c52"
};
const FB_URL = FB_CONFIG.databaseURL;
// –ú–∞—Å—Ç–µ—Ä-–ø–∞—Ä–æ–ª—å —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ Firebase: finflow_meta/_system/master_password
// –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤—Ä–µ–º–µ–Ω–Ω—ã–π –ø–∞—Ä–æ–ª—å: setup1234

const COLORS = ['#6c8dfa','#ff87b2','#4ecca3','#ffa94d','#b197fc','#ff6b6b','#ffd43b','#38bdf8','#f472b6','#34d399','#fb923c','#a78bfa'];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let db       = null;
let metaRef  = null;
let accounts = {}; // { accId: { name, color, users: { userId: {name,login,password,role,color} } } }
let _editingAccId   = null;
let _editingUserId  = null;
let _addingToAccId  = null;
let _selAccColor    = COLORS[0];
let _selUserColor   = COLORS[1];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _db = null; // temp db during login

function adminLogin(){
  const val = document.getElementById('masterInput').value.trim();
  if(!val) return;
  const btn = document.querySelector('.login-btn');
  btn.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞...';
  btn.disabled = true;
  document.getElementById('loginErr').textContent = '';

  // Destroy previous app if any
  Promise.all(firebase.apps.map(a => a.delete().catch(()=>{}))).then(() => {
    firebase.initializeApp(Object.assign({}, FB_CONFIG));
    _db = firebase.database();
    const auth = firebase.auth();

    // Try anon auth, but proceed after 3s regardless
    let proceeded = false;
    const proceed = () => {
      if(proceeded) return;
      proceeded = true;
      _db.ref('finflow_meta/_admin/master_password').once('value')
        .then(snap => {
          const stored = String(snap.val() || '');
          if(!stored || val === stored){
            // Success
            localStorage.setItem('ff_adm', val);
            db = _db;
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('adminApp').style.display = 'flex';
            afterFirebaseInit();
          } else {
            document.getElementById('loginErr').textContent = '‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å';
            setTimeout(()=>document.getElementById('loginErr').textContent='', 3000);
            btn.textContent = '–í–æ–π—Ç–∏ –≤ –ø–∞–Ω–µ–ª—å';
            btn.disabled = false;
            _db.app.delete().catch(()=>{});
          }
        })
        .catch(err => {
          // Firebase read blocked ‚Äî try cached password
          const cached = localStorage.getItem('ff_adm');
          if(cached && val === cached){
            db = _db;
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('adminApp').style.display = 'flex';
            afterFirebaseInit();
          } else {
            document.getElementById('loginErr').textContent = '‚ùå ' + err.message;
            btn.textContent = '–í–æ–π—Ç–∏ –≤ –ø–∞–Ω–µ–ª—å';
            btn.disabled = false;
          }
        });
    };

    auth.onAuthStateChanged(user => { if(user) proceed(); });
    auth.signInAnonymously().catch(() => proceed());
    setTimeout(proceed, 3000);
  });
}


function adminLogout(){
  if(db){ try{ db.ref('.info/connected').off(); }catch(e){} }
  try{ firebase.apps.forEach(a=>a.delete()); }catch(e){}
  db = null; metaRef = null; accounts = {};
  document.getElementById('adminApp').style.display = 'none';
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('masterInput').value = '';
  document.querySelector('.login-btn').textContent = '–í–æ–π—Ç–∏ –≤ –ø–∞–Ω–µ–ª—å';
  document.querySelector('.login-btn').disabled = false;
}

function openChangeMasterPass(){
  const cur = prompt('–¢–µ–∫—É—â–∏–π –º–∞—Å—Ç–µ—Ä-–ø–∞—Ä–æ–ª—å:');
  if(!cur) return;
  // Verify current password against Firebase
  db.ref('finflow_meta/_admin/master_password').once('value').then(snap=>{
    const stored = snap.val() || 'setup1234';
    if(cur !== stored){ showToast('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ç–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å'); return; }
    const np1 = prompt('–ù–æ–≤—ã–π –º–∞—Å—Ç–µ—Ä-–ø–∞—Ä–æ–ª—å (–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤):');
    if(!np1 || np1.length < 6){ showToast('‚ùå –ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤'); return; }
    const np2 = prompt('–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å:');
    if(np1 !== np2){ showToast('‚ùå –ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç'); return; }
    db.ref('finflow_meta/_admin/master_password').set(np1).then(()=>{
      showToast('‚úÖ –ú–∞—Å—Ç–µ—Ä-–ø–∞—Ä–æ–ª—å –∏–∑–º–µ–Ω—ë–Ω!');
    });
  });
}

document.getElementById('masterInput').addEventListener('keydown', e=>{
  if(e.key==='Enter') adminLogin();
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FIREBASE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function afterFirebaseInit(){
  metaRef = db.ref('finflow_meta');

  db.ref('.info/connected').on('value', snap=>{
    const dot  = document.getElementById('syncDot');
    const text = document.getElementById('syncText');
    if(snap.val()){
      dot.className  = 'sync-dot';
      text.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ Firebase';
    } else {
      dot.className  = 'sync-dot offline';
      text.textContent = '–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
    }
  });

  // Wait for auth to be ready, then listen to accounts
  const SKIP_KEYS = ['_system', '_admin'];
  const startListening = () => {
    metaRef.on('value', snap=>{
      accounts = {};
      const data = snap.val() || {};
      Object.entries(data).forEach(([accId, accData])=>{
        if(SKIP_KEYS.includes(accId)) return;
        if(typeof accData !== 'object' || !accData) return;
        accounts[accId] = {
          name:  accData.name  || accId,
          color: accData.color || COLORS[0],
          users: accData.users || {},
        };
      });
      renderAccounts();
      updateStats();
    });
  };

  // Auth state guaranteed by login flow, but double-check
  const auth = firebase.auth();
  if(auth.currentUser){
    startListening();
  } else {
    const unsub = auth.onAuthStateChanged(user => {
      unsub();
      startListening();
    });
    // Fallback if auth event never fires
    setTimeout(startListening, 2000);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateStats(){
  let totalUsers = 0, totalAdmins = 0;
  Object.values(accounts).forEach(acc=>{
    Object.values(acc.users||{}).forEach(u=>{
      totalUsers++;
      if(u.role==='admin') totalAdmins++;
    });
  });
  document.getElementById('statAccounts').textContent = Object.keys(accounts).length;
  document.getElementById('statUsers').textContent    = totalUsers;
  document.getElementById('statAdmins').textContent   = totalAdmins;
}

function roleLabel(role){
  return {admin:'–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä', editor:'–†–µ–¥–∞–∫—Ç–æ—Ä', viewer:'–ß–∏—Ç–∞—Ç–µ–ª—å'}[role] || role;
}
function roleBadgeClass(role){
  return {admin:'role-admin', editor:'role-editor', viewer:'role-viewer'}[role] || 'role-viewer';
}

function renderAccounts(){
  const grid = document.getElementById('accountsGrid');
  const accList = Object.entries(accounts);
  if(!accList.length){
    grid.innerHTML = `<div class="empty"><div class="empty-icon">üìÇ</div><div class="empty-text">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–æ–≤ ‚Äî —Å–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π</div></div>`;
    return;
  }
  grid.innerHTML = accList.map(([accId, acc])=>{
    const users = Object.entries(acc.users||{});
    const userRows = users.map(([uid, u])=>`
      <div class="user-row">
        <div class="user-avatar" style="background:${u.color||COLORS[2]}">${(u.name||'?')[0].toUpperCase()}</div>
        <div style="flex:1">
          <div class="user-name">${u.name||'‚Äî'}</div>
          <div class="user-login">${u.login||uid}</div>
        </div>
        <span class="role-badge ${roleBadgeClass(u.role)}">${roleLabel(u.role)}</span>
        <button class="btn btn-secondary btn-sm" onclick="openEditUser('${accId}','${uid}')" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
        <button class="btn btn-danger btn-sm" onclick="deleteUser('${accId}','${uid}','${(u.name||'').replace(/'/g,'')}')">üóë</button>
      </div>
    `).join('');

    return `
    <div class="account-card fade-in">
      <div class="account-card-header">
        <div class="account-icon" style="background:${acc.color}">${(acc.name||accId)[0].toUpperCase()}</div>
        <div style="flex:1">
          <div class="account-name">${acc.name}</div>
          <div class="account-room">ID: ${accId}</div>
        </div>
        <div class="account-actions">
          <button class="btn btn-danger btn-sm" onclick="deleteAccount('${accId}','${(acc.name||'').replace(/'/g,'')}')">üóë</button>
        </div>
      </div>
      <div class="users-list">
        ${userRows}
        <div class="add-user-row" onclick="openAddUser('${accId}')">
          <span style="font-size:16px">Ôºã</span> –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        </div>
      </div>
    </div>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RESET CATEGORIES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function resetAllAccountsCategories(){
  if(!confirm('–°–∫–∏–Ω—É—Ç–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó –¥–ª—è –í–°–Ü–• –∞–∫–∞—É–Ω—Ç—ñ–≤? –í–ª–∞—Å–Ω—ñ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó —Ç–∞ –ø–æ—Ä—è–¥–æ–∫ –±—É–¥—É—Ç—å –≤–∏–¥–∞–ª–µ–Ω—ñ.')) return;
  const accIds = Object.keys(accounts);
  if(!accIds.length){ alert('–ù–µ–º–∞—î –∞–∫–∞—É–Ω—Ç—ñ–≤'); return; }
  let done = 0;
  accIds.forEach(accId => {
    db.ref('finflow/' + accId + '/cfg').once('value').then(snap => {
      const cfg = snap.val() || {};
      // Remove category-related fields ‚Äî app will reload defaults
      delete cfg.customCats;
      delete cfg.catOrder;
      delete cfg.catColors;
      db.ref('finflow/' + accId + '/cfg').set(cfg).then(() => {
        done++;
        if(done === accIds.length){
          alert('‚úÖ –ö–∞—Ç–µ–≥–æ—Ä—ñ—ó —Å–∫–∏–Ω—É—Ç—ñ –¥–ª—è –≤—Å—ñ—Ö ' + done + ' –∞–∫–∞—É–Ω—Ç—ñ–≤. –ü—Ä–∏ –Ω–∞—Å—Ç—É–ø–Ω–æ–º—É –≤—Ö–æ–¥—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ –ø–æ–±–∞—á–∞—Ç—å –Ω–æ–≤—ñ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ñ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó.');
        }
      });
    });
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ACCOUNT CRUD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openCreateAccount(){
  _editingAccId = null;
  document.getElementById('accId').value   = '';
  document.getElementById('accName').value = '';
  document.getElementById('accId').disabled = false;
  document.getElementById('modalAccountTitle').textContent = '–ù–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç';
  _selAccColor = COLORS[0];
  renderColorPicker('accColorPicker', COLORS, _selAccColor, c=>{ _selAccColor=c; });
  openModal('modalAccount');
}

function saveAccount(){
  const id   = document.getElementById('accId').value.trim();
  const name = document.getElementById('accName').value.trim();
  if(!id)  { showToast('‚ùå –í–≤–µ–¥–∏—Ç–µ ID –∞–∫–∫–∞—É–Ω—Ç–∞'); return; }
  if(!name){ showToast('‚ùå –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ'); return; }
  if(!_editingAccId && accounts[id]){ showToast('‚ùå –ê–∫–∫–∞—É–Ω—Ç —Å —Ç–∞–∫–∏–º ID —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç'); return; }

  const accData = { name, color: _selAccColor };
  if(_editingAccId){
    metaRef.child(_editingAccId).update(accData);
    showToast(`‚úÖ –ê–∫–∫–∞—É–Ω—Ç ¬´${name}¬ª –æ–±–Ω–æ–≤–ª—ë–Ω`);
  } else {
    metaRef.child(id).set(accData);
    showToast(`‚úÖ –ê–∫–∫–∞—É–Ω—Ç ¬´${name}¬ª —Å–æ–∑–¥–∞–Ω`);
  }
  closeModal('modalAccount');
}

function deleteAccount(accId, accName){
  if(!confirm(`–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç ¬´${accName}¬ª?\n\n–í–ù–ò–ú–ê–ù–ò–ï: –í—Å–µ –¥–∞–Ω–Ω—ã–µ –±—é–¥–∂–µ—Ç–∞ —ç—Ç–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ —Ç–∞–∫–∂–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã!`)) return;
  metaRef.child(accId).remove();
  db.ref('finflow/'+accId).remove();
  showToast(`üóë –ê–∫–∫–∞—É–Ω—Ç ¬´${accName}¬ª —É–¥–∞–ª—ë–Ω`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  USER CRUD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openAddUser(accId){
  _addingToAccId = accId;
  _editingUserId = null;
  const acc = accounts[accId];
  document.getElementById('modalUserTitle').textContent = '–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
  document.getElementById('modalUserSub').textContent   = `–ê–∫–∫–∞—É–Ω—Ç: ${acc.name}`;
  document.getElementById('userName').value     = '';
  document.getElementById('userLogin').value    = '';
  document.getElementById('userPassword').value = '';
  document.getElementById('userRole').value     = 'editor';
  document.getElementById('saveUserBtn').textContent = '–î–æ–±–∞–≤–∏—Ç—å';
  _selUserColor = COLORS[Math.floor(Math.random()*COLORS.length)];
  renderColorPicker('userColorPicker', COLORS, _selUserColor, c=>{ _selUserColor=c; });
  openModal('modalUser');
}

function openEditUser(accId, userId){
  _addingToAccId = accId;
  _editingUserId = userId;
  const u = accounts[accId].users[userId];
  const acc = accounts[accId];
  document.getElementById('modalUserTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è';
  document.getElementById('modalUserSub').textContent   = `–ê–∫–∫–∞—É–Ω—Ç: ${acc.name}`;
  document.getElementById('userName').value     = u.name  || '';
  document.getElementById('userLogin').value    = u.login || userId;
  document.getElementById('userPassword').value = u.password || '';
  document.getElementById('userRole').value     = u.role  || 'editor';
  document.getElementById('saveUserBtn').textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
  _selUserColor = u.color || COLORS[0];
  renderColorPicker('userColorPicker', COLORS, _selUserColor, c=>{ _selUserColor=c; });
  openModal('modalUser');
}

function saveUser(){
  const name     = document.getElementById('userName').value.trim();
  const login    = document.getElementById('userLogin').value.trim();
  const password = document.getElementById('userPassword').value.trim();
  const role     = document.getElementById('userRole').value;
  if(!name)    { showToast('‚ùå –í–≤–µ–¥–∏—Ç–µ –∏–º—è'); return; }
  if(!login)   { showToast('‚ùå –í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω'); return; }
  if(!password || password.length < 3){ showToast('‚ùå –ü–∞—Ä–æ–ª—å –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞'); return; }

  const userId   = _editingUserId || login;
  const userData = { name, login, password, role, color: _selUserColor };
  metaRef.child(_addingToAccId).child('users').child(userId).set(userData);
  showToast(`‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ¬´${name}¬ª ${_editingUserId ? '–æ–±–Ω–æ–≤–ª—ë–Ω' : '–¥–æ–±–∞–≤–ª–µ–Ω'}`);
  closeModal('modalUser');
}

function deleteUser(accId, userId, userName){
  if(!confirm(`–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ¬´${userName}¬ª?`)) return;
  metaRef.child(accId).child('users').child(userId).remove();
  showToast(`üóë –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ¬´${userName}¬ª —É–¥–∞–ª—ë–Ω`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UI HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderColorPicker(containerId, colors, selected, onChange){
  const el = document.getElementById(containerId);
  el.innerHTML = colors.map(c=>`
    <div class="color-dot ${c===selected?'selected':''}" style="background:${c}"
      onclick="selectColor('${containerId}','${c}')"></div>
  `).join('');
  el._onChange = onChange;
}

function selectColor(containerId, color){
  const el = document.getElementById(containerId);
  el.querySelectorAll('.color-dot').forEach(d=>{
    d.classList.toggle('selected', d.style.background===color || d.style.backgroundColor===color);
  });
  if(el._onChange) el._onChange(color);
  if(containerId==='accColorPicker')  _selAccColor  = color;
  if(containerId==='userColorPicker') _selUserColor = color;
}

function openModal(id){ document.getElementById(id).classList.add('open'); }
function closeModal(id){ document.getElementById(id).classList.remove('open'); }

function showToast(msg){
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'), 3000);
}

// Close modal on overlay click
document.querySelectorAll('.modal-overlay').forEach(o=>{
  o.addEventListener('click', e=>{ if(e.target===o) closeModal(o.id); });
});

// Auto-focus on login
window.addEventListener('load', ()=>{ document.getElementById('masterInput').focus(); });
</script>
</body>
</html>
