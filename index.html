<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="format-detection" content="telephone=no">
<title>FinFlow</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script>window._fbLoaded = true;</script>
<style>
:root {
  --bg:#0d0f14;--surface:#161a22;--surface2:#1e2330;--surface3:#252d3d;
  --border:rgba(255,255,255,0.08);--text:#ffffff;--text2:#a0aabb;--text3:#5a6478;
  --accent:#6c8dfa;--red:#ff6b6b;--green:#4ecca3;--purple:#b197fc;
  --amount-color:#ffffff;--u1:#6c8dfa;--u2:#ff87b2;--shared:#4ecca3;
  --nav-h:68px;--safe-bottom:env(safe-area-inset-bottom, 0px);
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;overflow:hidden;background:var(--bg);}
body{font-family:'DM Sans',sans-serif;color:var(--text);display:flex;flex-direction:column;}

/* ‚îÄ‚îÄ SYNC STATUS BAR ‚îÄ‚îÄ */
.sync-bar{display:flex;align-items:center;justify-content:center;gap:6px;padding:5px 16px;font-size:11px;font-weight:600;transition:all .3s;flex-shrink:0;}
.sync-bar.online{background:rgba(78,204,163,.12);color:var(--green);}
.sync-bar.offline{background:rgba(255,107,107,.12);color:var(--red);}
.sync-bar.syncing{background:rgba(108,141,250,.12);color:var(--accent);}
.sync-bar.setup{background:rgba(255,169,77,.12);color:#ffa94d;}
.sync-dot{width:6px;height:6px;border-radius:50%;background:currentColor;flex-shrink:0;}
.sync-dot.pulse{animation:pulse 1.2s infinite;}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

/* ‚îÄ‚îÄ TOP HEADER ‚îÄ‚îÄ */
.top-header{display:flex;align-items:center;justify-content:space-between;padding:10px 16px 8px;background:var(--surface);border-bottom:1px solid var(--border);flex-shrink:0;}
.logo{font-family:'Syne',sans-serif;font-weight:800;font-size:20px;display:flex;align-items:center;gap:6px;}
.logo-dot{width:7px;height:7px;border-radius:50%;background:var(--accent);}
.header-actions{display:flex;gap:8px;align-items:center;}
.hbtn{width:38px;height:38px;border-radius:10px;background:var(--surface2);border:1px solid var(--border);color:var(--text2);display:flex;align-items:center;justify-content:center;font-size:18px;cursor:pointer;transition:all .15s;}
.hbtn:active{background:var(--surface3);transform:scale(.94);}

/* ‚îÄ‚îÄ USER SWITCHER ‚îÄ‚îÄ */
.user-switcher{display:flex;padding:10px 16px 6px;gap:8px;flex-shrink:0;}
.usr-pill{flex:1;display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:14px;background:var(--surface2);border:1.5px solid transparent;cursor:pointer;transition:all .2s;position:relative;}
.usr-pill.active{background:var(--surface3);border-color:var(--border);}
.usr-pill:active{transform:scale(.97);}
.usr-av{width:30px;height:30px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-family:'Syne',sans-serif;font-weight:800;font-size:13px;color:white;flex-shrink:0;}
.usr-info{flex:1;min-width:0;}
.usr-name{font-size:12px;font-weight:600;color:var(--text);line-height:1.2;}
.usr-amt{font-size:10px;color:var(--text3);font-weight:500;}
.usr-badge{position:absolute;top:4px;right:4px;width:16px;height:16px;border-radius:8px;font-size:9px;font-weight:700;color:white;display:flex;align-items:center;justify-content:center;}
.usr-sum{flex:0 0 auto;display:flex;align-items:center;gap:6px;padding:10px 14px;border-radius:14px;background:var(--surface2);border:1.5px solid transparent;cursor:pointer;transition:all .2s;}
.usr-sum.active{background:var(--surface3);border-color:var(--shared);}
.usr-sum:active{transform:scale(.97);}
.usr-sum-icon{font-size:18px;}
.usr-sum-info{display:flex;flex-direction:column;}
.usr-sum-label{font-size:9px;color:var(--text3);font-weight:600;text-transform:uppercase;letter-spacing:.04em;}
.usr-sum-val{font-size:11px;font-weight:700;color:var(--green);font-family:'Syne',sans-serif;}

/* ‚îÄ‚îÄ MAIN CONTENT AREA ‚îÄ‚îÄ */
.main-area{flex:1;overflow:hidden;display:flex;flex-direction:column;position:relative;}

/* ‚îÄ‚îÄ VIEWS ‚îÄ‚îÄ */
.view{display:none;flex-direction:column;flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;padding-bottom:calc(var(--nav-h) + var(--safe-bottom) + 10px);}
.view.active{display:flex;}

/* ‚îÄ‚îÄ CALENDAR VIEW ‚îÄ‚îÄ */
.cal-header{display:flex;align-items:center;gap:8px;padding:10px 16px;background:var(--bg);border-bottom:1px solid var(--border);flex-shrink:0;position:sticky;top:0;z-index:10;}
.cal-nav-btn{width:36px;height:36px;border-radius:10px;background:var(--surface);border:1px solid var(--border);color:var(--text2);display:flex;align-items:center;justify-content:center;font-size:18px;cursor:pointer;flex-shrink:0;}
.cal-nav-btn:active{background:var(--surface2);transform:scale(.93);}
.cal-month{font-family:'Syne',sans-serif;font-weight:700;font-size:15px;flex:1;text-align:center;color:var(--text);}
.cal-today-btn{padding:7px 12px;border-radius:9px;background:transparent;border:1px solid var(--accent);color:var(--accent);font-size:12px;font-weight:600;cursor:pointer;white-space:nowrap;}
.cal-today-btn:active{background:rgba(108,141,250,.15);}

.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:1px;background:var(--border);margin:10px 12px 0;border-radius:14px;overflow:hidden;border:1px solid var(--border);}
.cal-dow{background:var(--surface);text-align:center;padding:8px 0;font-size:9px;font-weight:700;letter-spacing:.07em;text-transform:uppercase;color:var(--text3);}
.cal-cell{background:var(--surface);min-height:72px;padding:6px 4px 4px;cursor:pointer;transition:background .12s;position:relative;overflow:hidden;}
.cal-cell:active{background:var(--surface3);}
.cal-cell.other-month{background:#11141a;}
.cal-cell.other-month .cell-day{color:var(--text3);}
.cal-cell.today{background:rgba(108,141,250,.07);}
.cal-cell.today::after{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:var(--accent);}
.cell-day{font-size:11px;font-weight:500;color:var(--text2);width:20px;height:20px;border-radius:6px;display:flex;align-items:center;justify-content:center;margin-bottom:3px;}
.cal-cell.today .cell-day{background:var(--accent);color:white;font-weight:700;}
.cell-exp-dot{display:flex;flex-wrap:wrap;gap:2px;margin-bottom:2px;}
.cell-dot{width:5px;height:5px;border-radius:50%;flex-shrink:0;}
.cell-total{font-size:9px;color:var(--amount-color);font-weight:600;opacity:.9;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

/* Week totals inline */
.week-totals-row{display:flex;align-items:center;justify-content:flex-end;gap:4px;padding:4px 12px 0;font-size:9px;color:var(--text3);}
.wt-chip{background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:2px 8px;font-family:'Syne',sans-serif;font-weight:700;font-size:10px;color:var(--amount-color);}

.month-summary{margin:10px 12px;background:var(--surface2);border-radius:12px;border:1px solid var(--accent);padding:12px 16px;display:flex;align-items:center;justify-content:space-between;}
.ms-label{font-size:11px;color:var(--text3);text-transform:uppercase;letter-spacing:.06em;font-weight:600;}
.ms-amount{font-family:'Syne',sans-serif;font-size:20px;font-weight:800;color:var(--amount-color);}
.ms-curr{font-size:11px;color:var(--text3);}

/* ‚îÄ‚îÄ FEED / RECENT ‚îÄ‚îÄ */
.section-title{padding:14px 16px 8px;font-family:'Syne',sans-serif;font-size:13px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:.07em;}
.expense-card{display:flex;align-items:center;gap:12px;padding:12px 16px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .12s;active:background:var(--surface2);}
.expense-card:active{background:var(--surface2);}
.exp-icon{width:40px;height:40px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:19px;flex-shrink:0;}
.exp-info{flex:1;min-width:0;}
.exp-name{font-size:14px;font-weight:600;color:var(--text);margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.exp-meta{font-size:11px;color:var(--text3);}
.exp-right{text-align:right;flex-shrink:0;}
.exp-amt{font-family:'Syne',sans-serif;font-size:15px;font-weight:700;color:var(--amount-color);}
.exp-user-tag{font-size:9px;font-weight:700;padding:2px 6px;border-radius:5px;color:white;display:inline-block;margin-top:2px;}
.new-badge{display:inline-block;width:6px;height:6px;border-radius:50%;background:var(--green);margin-left:4px;vertical-align:middle;animation:pulse 1.5s infinite;}

/* ‚îÄ‚îÄ CHARTS VIEW ‚îÄ‚îÄ */
.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:12px 16px;}
.stat-card{background:var(--surface);border-radius:14px;border:1px solid var(--border);padding:14px;}
.stat-label{font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.06em;font-weight:600;margin-bottom:6px;}
.stat-value{font-family:'Syne',sans-serif;font-size:20px;font-weight:800;color:var(--amount-color);}
.stat-sub{font-size:10px;color:var(--text3);margin-top:3px;}
.up{color:var(--red);}.down{color:var(--green);}

.chart-card{background:var(--surface);border-radius:14px;border:1px solid var(--border);padding:16px;margin:0 16px 12px;}
.chart-title{font-family:'Syne',sans-serif;font-size:14px;font-weight:700;margin-bottom:14px;color:var(--text);}
.bar-chart{display:flex;flex-direction:column;gap:9px;}
.bar-item{display:flex;align-items:center;gap:10px;}
.bar-label{font-size:11px;color:var(--text2);width:90px;flex-shrink:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.bar-track{flex:1;height:7px;background:var(--surface2);border-radius:4px;overflow:hidden;}
.bar-fill{height:100%;border-radius:4px;transition:width .4s;}
.bar-amount{font-size:11px;font-weight:600;width:75px;text-align:right;color:var(--amount-color);}

.compare-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:0 16px 12px;}
.compare-card{background:var(--surface2);border-radius:14px;border:1px solid var(--border);padding:14px;}
.compare-head{display:flex;align-items:center;gap:8px;margin-bottom:10px;}
.compare-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
.compare-name{font-family:'Syne',sans-serif;font-weight:700;font-size:13px;}
.compare-total{font-family:'Syne',sans-serif;font-size:20px;font-weight:800;color:var(--amount-color);}
.compare-sub{font-size:10px;color:var(--text3);margin-top:2px;}
.versus-bar{height:10px;border-radius:6px;overflow:hidden;background:var(--surface3);display:flex;margin:12px 16px 6px;}
.versus-fill1{background:var(--u1);height:100%;transition:width .4s;}
.versus-fill2{background:var(--u2);height:100%;transition:width .4s;}
.versus-labels{display:flex;justify-content:space-between;font-size:11px;padding:0 16px;}

.donut-wrap{display:flex;align-items:center;gap:16px;}
.donut-legend{display:flex;flex-direction:column;gap:6px;flex:1;}
.legend-item{display:flex;align-items:center;gap:7px;font-size:11px;}
.legend-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;}
.legend-name{color:var(--text2);flex:1;}
.legend-pct{font-weight:600;color:var(--amount-color);}

/* ‚îÄ‚îÄ PLAN VIEW ‚îÄ‚îÄ */
.plan-header-bar{padding:14px 16px 8px;display:flex;align-items:center;justify-content:space-between;}
.plan-title{font-family:'Syne',sans-serif;font-size:18px;font-weight:800;}
.plan-month{font-size:12px;color:var(--text3);}
.plan-grid{display:flex;flex-direction:column;gap:8px;padding:0 16px 8px;}
.plan-card{background:var(--surface);border-radius:14px;border:1px solid var(--border);padding:14px;}
.plan-card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
.plan-cat{display:flex;align-items:center;gap:8px;font-size:13px;font-weight:600;color:var(--text);}
.plan-cat-dot{width:8px;height:8px;border-radius:50%;}
.plan-amounts{display:flex;justify-content:space-between;font-size:11px;color:var(--text2);margin-bottom:7px;}
.plan-amounts .av{color:var(--amount-color);font-weight:600;}
.plan-bar-track{height:5px;background:var(--surface2);border-radius:3px;overflow:hidden;}
.plan-bar-fill{height:100%;border-radius:3px;transition:width .4s;}
.plan-pct{font-size:10px;color:var(--text3);margin-top:5px;}

/* ‚îÄ‚îÄ SETTINGS VIEW ‚îÄ‚îÄ */
.settings-content{padding:12px 16px;display:flex;flex-direction:column;gap:12px;}
.settings-section{background:var(--surface);border-radius:14px;border:1px solid var(--border);padding:16px;}
.settings-section h3{font-family:'Syne',sans-serif;font-size:14px;font-weight:700;color:var(--text);margin-bottom:14px;padding-bottom:10px;border-bottom:1px solid var(--border);}
.settings-row{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border);}
.settings-row:last-child{border-bottom:none;padding-bottom:0;}
.settings-row-label{font-size:13px;color:var(--text);}
.settings-row-sub{font-size:11px;color:var(--text3);margin-top:2px;}
.color-row{display:flex;align-items:center;justify-content:space-between;padding:9px 0;border-bottom:1px solid var(--border);}
.color-row:last-child{border-bottom:none;}
.crLeft{display:flex;align-items:center;gap:8px;}
.cr-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
.crRight{display:flex;align-items:center;gap:8px;}
.cp2{width:34px;height:34px;border-radius:8px;border:2px solid var(--border);cursor:pointer;padding:2px;background:var(--surface2);}
.creset{font-size:11px;color:var(--text3);cursor:pointer;padding:5px 10px;border-radius:6px;border:1px solid var(--border);background:var(--surface2);font-family:'DM Sans',sans-serif;}
.cat-manage-row{display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border);}
.cat-manage-row:last-child{border-bottom:none;}
.cat-manage-name{flex:1;font-size:13px;font-weight:500;color:var(--text);}
.cat-manage-del{background:rgba(255,107,107,.15);color:var(--red);border:1px solid rgba(255,107,107,.3);border-radius:7px;padding:6px 12px;font-size:12px;cursor:pointer;font-family:'DM Sans',sans-serif;}
.cat-manage-del.default-cat{background:var(--surface3);color:var(--text3);border-color:var(--border);opacity:.6;}
.new-cat-form{background:var(--surface2);border-radius:12px;border:1px solid var(--border);padding:14px;margin-top:4px;}
.swatch-row{display:flex;gap:7px;flex-wrap:wrap;margin-top:10px;}
.sw{width:32px;height:32px;border-radius:8px;cursor:pointer;border:2px solid transparent;transition:all .15s;}
.sw.selected{border-color:white;transform:scale(1.1);}
.preview-box{margin-top:14px;padding:12px;background:var(--surface2);border-radius:10px;border:1px solid var(--border);}
.preview-label{font-size:11px;color:var(--text3);margin-bottom:6px;}
.pv-amt{font-family:'Syne',sans-serif;font-size:24px;font-weight:800;color:var(--amount-color);}
.color-palette{display:flex;gap:5px;flex-wrap:wrap;margin-top:8px;}
.cp-swatch{width:24px;height:24px;border-radius:6px;cursor:pointer;border:2px solid transparent;}
.cp-swatch.selected{border-color:white;}

/* Firebase setup card */
.firebase-setup{background:var(--surface);border-radius:14px;border:1.5px solid #ffa94d;padding:18px;}
.firebase-setup h3{font-family:'Syne',sans-serif;font-size:14px;font-weight:700;color:#ffa94d;margin-bottom:12px;}
.firebase-status{display:flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;margin-bottom:14px;font-size:13px;font-weight:500;}
.firebase-status.connected{background:rgba(78,204,163,.12);color:var(--green);}
.firebase-status.disconnected{background:rgba(255,107,107,.12);color:var(--red);}
.firebase-steps{font-size:12px;color:var(--text2);line-height:1.7;margin-bottom:14px;}
.firebase-steps a{color:var(--accent);}
.firebase-steps code{background:var(--surface2);padding:1px 5px;border-radius:4px;font-size:11px;}
.btn-connect{width:100%;padding:12px;border-radius:10px;background:var(--accent);color:white;border:none;font-family:'DM Sans',sans-serif;font-size:14px;font-weight:600;cursor:pointer;margin-top:6px;}
.btn-connect:active{background:#5579e8;transform:scale(.98);}
.btn-disconnect{width:100%;padding:10px;border-radius:10px;background:rgba(255,107,107,.15);color:var(--red);border:1px solid rgba(255,107,107,.3);font-family:'DM Sans',sans-serif;font-size:13px;font-weight:500;cursor:pointer;margin-top:8px;}

/* ‚îÄ‚îÄ BOTTOM NAV ‚îÄ‚îÄ */
.bottom-nav{height:var(--nav-h);background:var(--surface);border-top:1px solid var(--border);display:flex;align-items:stretch;padding-bottom:var(--safe-bottom);flex-shrink:0;position:relative;z-index:20;}
.nav-item{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;cursor:pointer;transition:all .15s;padding-top:4px;}
.nav-item:active{background:var(--surface2);}
.nav-icon{font-size:20px;line-height:1;}
.nav-label{font-size:9px;font-weight:600;letter-spacing:.04em;color:var(--text3);text-transform:uppercase;transition:color .15s;}
.nav-item.active .nav-label{color:var(--accent);}
.nav-item.active .nav-icon{transform:translateY(-1px);}
.nav-add{flex:0 0 64px;display:flex;align-items:center;justify-content:center;padding-top:4px;}
.nav-add-btn{width:50px;height:50px;border-radius:16px;background:var(--accent);color:white;display:flex;align-items:center;justify-content:center;font-size:26px;line-height:1;cursor:pointer;box-shadow:0 4px 20px rgba(108,141,250,.4);transition:all .15s;border:none;margin-top:-10px;}
.nav-add-btn:active{transform:scale(.92);box-shadow:0 2px 10px rgba(108,141,250,.3);}

/* ‚îÄ‚îÄ FAB (desktop only) ‚îÄ‚îÄ */
.fab{display:none;}

/* ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:100;align-items:flex-end;justify-content:center;backdrop-filter:blur(4px);}
.modal-overlay.open{display:flex;}
.modal{background:var(--surface);border-radius:22px 22px 0 0;width:100%;max-width:600px;padding:20px 20px calc(20px + var(--safe-bottom));animation:slideUp .25s ease;max-height:92vh;overflow-y:auto;}
@keyframes slideUp{from{transform:translateY(100%);opacity:0}to{transform:translateY(0);opacity:1}}
.modal-handle{width:36px;height:4px;background:var(--surface3);border-radius:2px;margin:0 auto 16px;}
.modal h2{font-family:'Syne',sans-serif;font-size:18px;font-weight:700;margin-bottom:18px;display:flex;align-items:center;justify-content:space-between;color:var(--text);}
.modal-close{width:30px;height:30px;border-radius:9px;background:var(--surface2);border:none;color:var(--text2);cursor:pointer;font-size:20px;display:flex;align-items:center;justify-content:center;}
.form-group{margin-bottom:14px;}
.form-label{font-size:12px;font-weight:500;color:var(--text2);margin-bottom:6px;display:block;}
.form-input,.form-select{width:100%;padding:12px 14px;background:var(--surface2);border:1.5px solid var(--border);border-radius:12px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:15px;outline:none;-webkit-appearance:none;}
.form-input:focus,.form-select:focus{border-color:var(--accent);}
.form-select option{background:var(--surface2);color:var(--text);}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.btn{padding:13px 20px;border-radius:12px;font-family:'DM Sans',sans-serif;font-size:15px;font-weight:600;cursor:pointer;transition:all .15s;border:none;width:100%;}
.btn:active{transform:scale(.97);}
.btn-primary{background:var(--accent);color:white;}
.btn-secondary{background:var(--surface2);color:var(--text2);border:1px solid var(--border);}
.btn-green{background:rgba(78,204,163,.2);color:var(--green);border:1px solid rgba(78,204,163,.4);}
.btn-danger{background:rgba(255,107,107,.15);color:var(--red);border:1px solid rgba(255,107,107,.3);}
.modal-footer{display:flex;gap:10px;margin-top:18px;}
.modal-footer .btn{flex:1;}

/* ‚îÄ‚îÄ BOTTOM SHEET (expense detail) ‚îÄ‚îÄ */
.bottom-sheet{display:none;position:fixed;inset:0;z-index:90;align-items:flex-end;justify-content:center;}
.bottom-sheet.open{display:flex;}
.bs-overlay{position:absolute;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(3px);}
.bs-content{background:var(--surface);border-radius:22px 22px 0 0;width:100%;max-width:600px;padding:16px 20px calc(20px + var(--safe-bottom));animation:slideUp .2s ease;position:relative;z-index:1;}
.bs-handle{width:36px;height:4px;background:var(--surface3);border-radius:2px;margin:0 auto 14px;}
.det-name{font-family:'Syne',sans-serif;font-weight:700;font-size:18px;margin-bottom:4px;}
.det-cat{font-size:12px;margin-bottom:12px;}
.det-amt{font-family:'Syne',sans-serif;font-size:32px;font-weight:800;margin-bottom:6px;color:var(--amount-color);}
.det-meta{font-size:12px;color:var(--text3);}
.det-note{font-size:13px;color:var(--text2);margin-top:6px;font-style:italic;}
.det-user{font-size:12px;font-weight:700;padding:3px 10px;border-radius:7px;color:white;display:inline-block;margin-top:8px;}
.det-actions{display:flex;gap:10px;margin-top:16px;}
.det-btn{flex:1;padding:12px;border-radius:12px;border:none;cursor:pointer;font-size:14px;font-family:'DM Sans',sans-serif;font-weight:600;}
.det-btn:active{transform:scale(.96);}

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
.toast{position:fixed;top:0;left:50%;transform:translateX(-50%) translateY(-80px);background:var(--surface);border:1px solid var(--border);color:var(--text);font-weight:600;padding:12px 20px;border-radius:14px;font-size:13.5px;z-index:999;opacity:0;transition:all .3s;pointer-events:none;max-width:90vw;text-align:center;box-shadow:0 10px 40px rgba(0,0,0,.4);}
.toast.show{opacity:1;transform:translateX(-50%) translateY(12px);}

/* ‚îÄ‚îÄ EMOJI PICKER ‚îÄ‚îÄ */
.emoji-picker{display:none;position:fixed;background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:12px;z-index:200;box-shadow:0 20px 60px rgba(0,0,0,.7);flex-wrap:wrap;gap:4px;max-width:280px;}
.emoji-picker.open{display:flex;}
.ep-emoji{font-size:22px;cursor:pointer;padding:6px;border-radius:7px;transition:background .1s;border:none;background:transparent;min-width:38px;text-align:center;}
.ep-emoji:active{background:var(--surface2);}

/* ‚îÄ‚îÄ DESKTOP OVERRIDES ‚îÄ‚îÄ */
@media(min-width:768px){
  body{flex-direction:row;}
  .bottom-nav{display:none;}
  .fab{display:flex;position:fixed;bottom:28px;right:28px;z-index:30;}
  .fab-btn{width:56px;height:56px;border-radius:18px;background:var(--accent);color:white;display:flex;align-items:center;justify-content:center;font-size:28px;cursor:pointer;box-shadow:0 6px 24px rgba(108,141,250,.45);border:none;transition:all .15s;}
  .fab-btn:hover{background:#5579e8;transform:scale(1.06);}

  .sidebar-desktop{width:220px;min-width:220px;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;padding:20px 0;overflow-y:auto;height:100vh;}
  .sidebar-logo-d{font-family:'Syne',sans-serif;font-weight:800;font-size:20px;padding:0 18px 18px;display:flex;align-items:center;gap:8px;}
  .sidebar-logo-dot{width:7px;height:7px;border-radius:50%;background:var(--accent);}
  .sd-label{font-size:10px;font-weight:600;letter-spacing:.08em;text-transform:uppercase;color:var(--text3);padding:0 8px;margin-bottom:6px;}
  .sd-section{padding:0 10px;margin-bottom:8px;}
  .sd-item{display:flex;align-items:center;gap:10px;padding:9px 12px;border-radius:10px;cursor:pointer;font-size:13px;font-weight:400;color:var(--text2);transition:all .15s;}
  .sd-item:hover{background:var(--surface2);color:var(--text);}
  .sd-item.active{background:var(--surface3);color:var(--text);font-weight:500;}
  .sd-icon{font-size:16px;width:20px;text-align:center;}
  .sd-bottom{margin-top:auto;padding:0 10px;border-top:1px solid var(--border);padding-top:14px;}
  .sd-add{display:flex;align-items:center;gap:8px;padding:8px 18px;font-size:12.5px;color:var(--text3);cursor:pointer;}
  .sd-add:hover{color:var(--accent);}

  .app-body{flex:1;display:flex;flex-direction:column;overflow:hidden;height:100vh;}
  .sync-bar{flex-shrink:0;}
  .top-header{flex-shrink:0;}
  .user-switcher{padding:10px 20px 6px;}
  .main-area{flex:1;overflow:hidden;}
  .view{padding-bottom:10px;}
  .modal-overlay{align-items:center;}
  .modal{border-radius:18px;max-width:480px;padding:26px;}
  @keyframes slideUp{from{opacity:0;transform:scale(.96) translateY(10px)}to{opacity:1;transform:none}}
  .bottom-sheet{align-items:center;}
  .bs-content{border-radius:16px;max-width:440px;padding:24px;}
  .cal-grid{margin:10px 20px 0;}
  .month-summary{margin:10px 20px;}
  .week-totals-row{padding:4px 20px 0;}
  .chart-card{margin:0 20px 12px;}
  .compare-row{padding:0 20px 12px;margin:0;}
  .versus-bar{margin:12px 20px 6px;}
  .versus-labels{padding:0 20px;}
  .settings-content{padding:12px 20px;}
  .stats-grid{padding:12px 20px;}
  .plan-grid{padding:0 20px 8px;}
  .section-title{padding:14px 20px 8px;}
  .expense-card{padding:12px 20px;}
  .cal-header{padding:10px 20px;}
  .plan-header-bar{padding:14px 20px 8px;}
  .cal-cell{min-height:90px;}
}

/* ‚îÄ‚îÄ iOS TOUCH FIX ‚îÄ‚îÄ */
/* iOS Safari requires cursor:pointer on non-button elements for onclick to fire */
.nav-item,.usr-pill,.usr-sum,.cal-cell,.expense-card,.cal-nav-btn,.hbtn,
.sd-item,.user-tab,.sidebar-item,.cat-manage-row,.color-row,.settings-row,
.plan-card,.det-btn,.ep-emoji,.cp-swatch,.sw,.cp2,.creset,.sidebar-add,
.sd-add,.cell-exp-dot,.cal-today-btn,.week-totals-row,.month-summary{
  cursor:pointer;
}
/* Make sure nothing blocks touches */
*{-webkit-user-select:none;user-select:none;}
input,textarea,select{-webkit-user-select:text;user-select:text;}

/* ‚îÄ‚îÄ UTILITIES ‚îÄ‚îÄ */
::-webkit-scrollbar{width:4px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--surface3);border-radius:2px;}
</style>
</head>
<body ontouchstart="">
<!-- LOGIN SCREEN ‚Äî Multi-Account -->
<div id="lockScreen" style="display:flex;position:fixed;inset:0;z-index:9999;background:#0d0f14;flex-direction:column;align-items:center;justify-content:center;padding:24px;overflow:hidden;">

  <!-- Glow background -->
  <div style="position:absolute;top:-20%;left:50%;transform:translateX(-50%);width:600px;height:600px;background:radial-gradient(ellipse,rgba(108,141,250,0.12) 0%,transparent 70%);pointer-events:none;animation:glowPulse 4s ease-in-out infinite;"></div>
  <div style="position:absolute;bottom:-10%;right:-10%;width:400px;height:400px;background:radial-gradient(ellipse,rgba(255,135,178,0.06) 0%,transparent 70%);pointer-events:none;animation:glowPulse 6s ease-in-out infinite reverse;"></div>

  <!-- Logo -->
  <div style="display:flex;flex-direction:column;align-items:center;margin-bottom:36px;animation:logoIn .8s cubic-bezier(.16,1,.3,1) both;">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
      <div style="width:10px;height:10px;border-radius:50%;background:#6c8dfa;animation:dotPulse 2s ease-in-out infinite;box-shadow:0 0 16px rgba(108,141,250,0.8);"></div>
      <span style="font-family:'Syne',sans-serif;font-weight:800;font-size:36px;letter-spacing:-1px;color:#fff;">FinFlow</span>
    </div>
    <span style="font-size:12px;color:#5a6478;letter-spacing:.14em;text-transform:uppercase;font-weight:500;">–°–µ–º–µ–π–Ω—ã–π –±—é–¥–∂–µ—Ç</span>
  </div>

  <!-- STEP 1: Account list -->
  <div id="stepAccounts" style="width:100%;max-width:340px;animation:formIn .9s cubic-bezier(.16,1,.3,1) .12s both;">
    <div style="font-size:11px;color:#5a6478;text-align:center;letter-spacing:.12em;text-transform:uppercase;font-weight:600;margin-bottom:16px;" id="step1Label">–í—ã–±–µ—Ä–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç</div>
    <div id="accountsList">
      <div style="text-align:center;padding:32px 0;color:#5a6478;font-size:13px;">
        <div style="font-size:28px;margin-bottom:10px;">‚è≥</div>
        –ó–∞–≥—Ä—É–∑–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–æ–≤...
      </div>
    </div>
  </div>

  <!-- STEP 2: User list (inside account) -->
  <div id="stepUsers" style="display:none;width:100%;max-width:340px;">
    <div onclick="goToStep(1)" style="display:flex;align-items:center;gap:6px;color:#5a6478;font-size:13px;margin-bottom:20px;cursor:pointer;width:fit-content;transition:color .15s;" onmouseover="this.style.color='#a0aabb'" onmouseout="this.style.color='#5a6478'">
      <span style="font-size:18px;">‚Äπ</span> –ù–∞–∑–∞–¥
    </div>
    <div id="selectedAccBadge" style="display:flex;align-items:center;gap:12px;padding:12px 16px;background:#1e2330;border-radius:14px;border:1px solid rgba(255,255,255,0.07);margin-bottom:20px;">
      <div id="accBadgeAvatar" style="width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-family:'Syne',sans-serif;font-weight:800;font-size:15px;color:#fff;"></div>
      <div id="accBadgeName" style="font-family:'Syne',sans-serif;font-weight:700;font-size:15px;color:#fff;"></div>
    </div>
    <div style="font-size:11px;color:#5a6478;letter-spacing:.12em;text-transform:uppercase;font-weight:600;margin-bottom:12px;">–ö—Ç–æ –≤—ã?</div>
    <div id="usersList"></div>
  </div>

  <!-- STEP 3: Password entry -->
  <div id="stepPassword" style="display:none;width:100%;max-width:340px;">
    <div onclick="goToStep(2)" style="display:flex;align-items:center;gap:6px;color:#5a6478;font-size:13px;margin-bottom:20px;cursor:pointer;width:fit-content;transition:color .15s;" onmouseover="this.style.color='#a0aabb'" onmouseout="this.style.color='#5a6478'">
      <span style="font-size:18px;">‚Äπ</span> –ù–∞–∑–∞–¥
    </div>

    <!-- Selected user card -->
    <div id="selUserCard" style="display:flex;align-items:center;gap:12px;padding:14px 16px;background:#1e2330;border:1px solid rgba(255,255,255,0.07);border-radius:16px;margin-bottom:24px;">
      <div id="selUserAvatar" style="width:44px;height:44px;border-radius:13px;display:flex;align-items:center;justify-content:center;font-family:'Syne',sans-serif;font-weight:800;font-size:18px;color:#fff;flex-shrink:0;"></div>
      <div>
        <div id="selUserName" style="font-family:'Syne',sans-serif;font-weight:700;font-size:16px;color:#fff;"></div>
        <div id="selUserMeta" style="font-size:11px;color:#5a6478;margin-top:2px;"></div>
      </div>
      <div style="margin-left:auto;font-size:18px;opacity:.3;">üîí</div>
    </div>

    <!-- PIN dots -->
    <div id="pinDots" style="display:flex;justify-content:center;gap:14px;margin-bottom:16px;min-height:20px;"></div>

    <!-- Password input ‚Äî always visible, triggers keyboard on mobile -->
    <div style="position:relative;margin-bottom:14px;" id="lockInputWrap">
      <input id="lockInput" type="password" inputmode="text" maxlength="20"
        autocomplete="current-password"
        onkeydown="if(event.key==='Enter')checkPassword()"
        oninput="updatePinDots(this.value)"
        placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å"
        onfocus="this.parentElement.style.boxShadow='0 0 0 3px rgba(108,141,250,0.3)';this.style.borderColor='#6c8dfa';"
        onblur="this.parentElement.style.boxShadow='none';this.style.borderColor='rgba(108,141,250,0.4)';"
        style="width:100%;padding:16px 48px 16px 18px;background:#1e2330;border:2px solid rgba(108,141,250,0.4);border-radius:14px;color:#fff;font-family:'DM Sans',sans-serif;font-size:16px;outline:none;transition:border-color .2s,box-shadow .2s;-webkit-appearance:none;appearance:none;">
      <span style="position:absolute;right:16px;top:50%;transform:translateY(-50%);font-size:16px;pointer-events:none;opacity:.4;">üîë</span>
    </div>
    <!-- lockTapArea kept as empty placeholder for JS compatibility -->
    <div id="lockTapArea" style="display:none;"></div>

    <button onclick="checkPassword()"
      style="width:100%;padding:15px;border-radius:14px;background:#6c8dfa;color:#fff;border:none;font-family:'DM Sans',sans-serif;font-size:15px;font-weight:600;cursor:pointer;box-shadow:0 6px 24px rgba(108,141,250,.35);transition:all .15s;"
      onmousedown="this.style.transform='scale(.97)'" onmouseup="this.style.transform=''"
      ontouchstart="this.style.transform='scale(.97)'" ontouchend="this.style.transform=''">
      –í–æ–π—Ç–∏ ‚Üí
    </button>

    <div id="lockError" style="font-size:12px;color:#ff6b6b;text-align:center;margin-top:12px;min-height:18px;"></div>
    <div onclick="showChangePassword()" style="font-size:11px;color:#3a4052;text-align:center;margin-top:18px;cursor:pointer;transition:color .15s;" onmouseover="this.style.color='#6c8dfa'" onmouseout="this.style.color='#3a4052'">–ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</div>
  </div>

</div>

<style>
@keyframes logoIn   {from{opacity:0;transform:translateY(-24px)}to{opacity:1;transform:none}}
@keyframes formIn   {from{opacity:0;transform:translateY(16px)} to{opacity:1;transform:none}}
@keyframes glowPulse{0%,100%{opacity:.7;transform:translateX(-50%) scale(1)}50%{opacity:1;transform:translateX(-50%) scale(1.06)}}
@keyframes dotPulse {0%,100%{box-shadow:0 0 10px rgba(108,141,250,.6)}50%{box-shadow:0 0 24px rgba(108,141,250,1)}}
@keyframes pinBounce{0%{transform:scale(0)}60%{transform:scale(1.3)}100%{transform:scale(1)}}
@keyframes lockShake{0%,100%{transform:translateX(0)}20%,60%{transform:translateX(-8px)}40%,80%{transform:translateX(8px)}}
@keyframes stepIn   {from{opacity:0;transform:translateX(16px)}to{opacity:1;transform:none}}
@keyframes stepOut  {from{opacity:1}to{opacity:0;transform:translateX(-16px)}}
</style>

<!-- DESKTOP SIDEBAR -->
<div class="sidebar-desktop" id="sidebarDesktop" style="display:none">
  <div class="sidebar-logo-d"><div class="sidebar-logo-dot"></div>FinFlow</div>
  <div class="sd-section">
    <div class="sd-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
    <div id="sdUsersList">
      <!-- populated dynamically in renderUserSwitcher() -->
      <div class="sd-item" id="sdTab-shared" onclick="setActiveUser('shared')">
        <div style="width:28px;height:28px;border-radius:8px;background:var(--shared);display:flex;align-items:center;justify-content:center;font-family:'Syne',sans-serif;font-weight:800;font-size:14px;color:white">‚àë</div>
        <div><div style="font-size:13px;font-weight:600">–û–±—â–∏–π</div><div id="sdBadge-shared" style="font-size:10px;color:var(--text3)">0 ‚ÇΩ</div></div>
      </div>
    </div>
  </div>
  <div class="sd-section" style="margin-top:6px">
    <div class="sd-label">–†–∞–∑–¥–µ–ª—ã</div>
    <div class="sd-item active" data-view="calendar" onclick="switchView('calendar')"><span class="sd-icon">üìÖ</span>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</div>
    <div class="sd-item" data-view="charts" onclick="switchView('charts')"><span class="sd-icon">üìä</span>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</div>
    <div class="sd-item" data-view="plan" onclick="switchView('plan')"><span class="sd-icon">üéØ</span>–ü–ª–∞–Ω</div>
  </div>
  <div class="sd-section" style="margin-top:6px">
    <div class="sd-label">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</div>
    <div id="sdCatList"></div>
  </div>
  <div class="sd-add" onclick="openAddModal()">Ôºã –î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥</div>
  <div class="sd-bottom">
    <div class="sd-item" data-view="settings" onclick="switchView('settings')"><span class="sd-icon">‚öôÔ∏è</span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
  </div>
</div>

<!-- APP BODY -->
<div class="app-body" id="appBody" style="flex:1;display:flex;flex-direction:column;overflow:hidden;">

  <!-- SYNC STATUS BAR -->
  <div class="sync-bar setup" id="syncBar">
    <div class="sync-dot"></div>
    <span id="syncText">–õ–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º ‚Äî –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ Firebase –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏</span>
  </div>

  <!-- TOP HEADER -->
  <div class="top-header">
    <div class="logo"><div class="logo-dot"></div>FinFlow</div>
    <div class="header-actions">
      <div class="hbtn" id="syncStatusBtn" onclick="switchView('settings')" title="–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è">‚òÅÔ∏è</div>
      <div class="hbtn" onclick="openAddModal()">Ôºã</div>
    </div>
  </div>

  <!-- USER SWITCHER ‚Äî populated dynamically in startApp() -->
  <div class="user-switcher" id="userSwitcher">
  </div>

  <!-- MAIN AREA -->
  <div class="main-area">

    <!-- CALENDAR VIEW -->
    <div class="view active" id="viewCalendar">
      <div class="cal-header">
        <button class="cal-nav-btn" onclick="prevMonth()">‚Äπ</button>
        <div class="cal-month" id="calMonthLabel"></div>
        <button class="cal-nav-btn" onclick="nextMonth()">‚Ä∫</button>
        <button class="cal-today-btn" onclick="goToToday()">–°–µ–≥–æ–¥–Ω—è</button>
      </div>
      <div id="calContainer"></div>
      <div class="section-title">–ù–µ–¥–∞–≤–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥—ã</div>
      <div id="recentList"></div>
    </div>

    <!-- CHARTS VIEW -->
    <div class="view" id="viewCharts">
      <div class="stats-grid" id="statsGrid"></div>
      <div id="compareSection"></div>
      <div class="chart-card"><div class="chart-title">–ü–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</div><div class="bar-chart" id="barChart"></div></div>
      <div class="chart-card"><div class="chart-title">–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ</div><div class="donut-wrap"><svg width="120" height="120" id="donutSvg"></svg><div class="donut-legend" id="donutLegend"></div></div></div>
      <div class="chart-card"><div class="chart-title">–î–∏–Ω–∞–º–∏–∫–∞ ‚Äî 6 –º–µ—Å.</div><svg width="100%" height="160" id="trendSvg" style="overflow:visible"></svg></div>
    </div>

    <!-- PLAN VIEW -->
    <div class="view" id="viewPlan">
      <div class="plan-header-bar">
        <div class="plan-title">–ü–ª–∞–Ω —Ä–∞—Å—Ö–æ–¥–æ–≤</div>
        <div class="plan-month" id="planMonthLabel"></div>
      </div>
      <div class="plan-grid" id="planGrid"></div>
    </div>

    <!-- SETTINGS VIEW -->
    <div class="view" id="viewSettings">
      <div class="settings-content">
        <div style="font-family:'Syne',sans-serif;font-size:20px;font-weight:800;padding:4px 0 10px">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>

        <!-- FIREBASE SYNC -->
        <div class="firebase-setup" id="firebaseSetup">
          <h3>‚òÅÔ∏è –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</h3>
          <div class="firebase-status disconnected" id="fbStatus">
            <span>‚óè</span>&nbsp;–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ
          </div>
          <div class="firebase-steps" id="fbSteps">
            –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –∏ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –û–±–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ä–∞–±–æ—Ç–∞—é—Ç —Å –æ–¥–Ω–æ–π –∏ —Ç–æ–π –∂–µ –±–∞–∑–æ–π.<br><br>
            –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å <strong>—Å–≤–æ—é</strong> –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö ‚Äî –∑–∞–º–µ–Ω–∏—Ç–µ URL –Ω–∏–∂–µ –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ü–æ–¥–∫–ª—é—á–∏—Ç—å¬ª.
          </div>
          <div class="form-group">
            <label class="form-label">URL Firebase Realtime Database</label>
            <input class="form-input" id="fbUrl" placeholder="https://family-budget-32149-default-rtdb.europe-west1.firebasedatabase.app" style="font-size:12px">
          </div>
          <div class="form-group">
            <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã (–æ–¥–∏–Ω–∞–∫–æ–≤–æ–µ —É –æ–±–æ–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)</label>
            <input class="form-input" id="fbRoom" placeholder="my-budget" style="font-size:13px">
          </div>
          <button class="btn-connect" onclick="connectFirebase()">üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å</button>
          <button class="btn-disconnect" id="btnDisconnect" style="display:none" onclick="disconnectFirebase()">‚úï –û—Ç–∫–ª—é—á–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é</button>
        </div>

        <!-- USERS -->
        <div class="settings-section">
          <h3>üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3>
          <div id="userSettingsList"></div>
        </div>


        <!-- CATEGORIES -->
        <div class="settings-section">
          <h3>üè∑ –ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h3>
          <div class="cat-manage-list" id="catManageList"></div>
          <div class="new-cat-form">
            <div style="font-size:12px;font-weight:600;color:var(--text2);margin-bottom:12px">‚ûï –ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è</div>
            <div class="form-row" style="margin-bottom:10px">
              <div class="form-group" style="margin:0"><label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label><input class="form-input" id="newCatName" placeholder="–°–ø–æ—Ä—Ç" style="font-size:13px"></div>
              <div class="form-group" style="margin:0;position:relative"><label class="form-label">–ò–∫–æ–Ω–∫–∞</label><button style="width:100%;height:46px;border-radius:12px;background:var(--surface);border:1.5px solid var(--border);font-size:22px;cursor:pointer;display:flex;align-items:center;justify-content:center;" id="emojiPickerBtn" onclick="toggleEmojiPicker(event)"><span id="selectedEmoji">üè∑</span></button><div class="emoji-picker" id="emojiPicker"></div></div>
            </div>
            <div class="form-group"><label class="form-label">–¶–≤–µ—Ç</label><input type="color" class="cp2" id="newCatColor" value="#a78bfa" style="width:100%;height:44px;border-radius:12px;"></div>
            <div><label class="form-label">–ë—ã—Å—Ç—Ä—ã–π —Ü–≤–µ—Ç</label><div class="color-palette" id="newCatColorPalette"></div></div>
            <button class="btn btn-green" style="margin-top:12px" onclick="addCustomCat()">+ –î–æ–±–∞–≤–∏—Ç—å</button>
          </div>
        </div>

        <!-- CAT COLORS -->
        <div class="settings-section">
          <h3>üé® –¶–≤–µ—Ç–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π</h3>
          <div id="catColorList"></div>
          <button class="btn btn-secondary" style="margin-top:12px;font-size:13px" onclick="resetAllCats()">‚Ü∫ –°–±—Ä–æ—Å–∏—Ç—å</button>
        </div>

        <!-- AMOUNT COLOR -->
        <div class="settings-section">
          <h3>üí∞ –¶–≤–µ—Ç —Å—É–º–º</h3>
          <div style="display:flex;gap:10px;align-items:flex-end">
            <div class="form-group" style="margin:0;flex:1"><label class="form-label">HEX</label><input class="form-input" id="amtHex" placeholder="#ffffff" oninput="syncAmtHex(this.value)"></div>
            <div><label class="form-label">–¶–≤–µ—Ç</label><input type="color" class="cp2" id="amtPicker" oninput="syncAmtPicker(this.value)" style="width:46px;height:46px;border-radius:10px;"></div>
          </div>
          <div class="swatch-row">
            <div class="sw" style="background:#ffffff;border:1px solid rgba(255,255,255,.2)" onclick="setAmtColor('#ffffff')"></div>
            <div class="sw" style="background:#4ecca3" onclick="setAmtColor('#4ecca3')"></div>
            <div class="sw" style="background:#6c8dfa" onclick="setAmtColor('#6c8dfa')"></div>
            <div class="sw" style="background:#ffd43b" onclick="setAmtColor('#ffd43b')"></div>
            <div class="sw" style="background:#ff87b2" onclick="setAmtColor('#ff87b2')"></div>
            <div class="sw" style="background:#ffa94d" onclick="setAmtColor('#ffa94d')"></div>
            <div class="sw" style="background:#b197fc" onclick="setAmtColor('#b197fc')"></div>
          </div>
          <div class="preview-box"><div class="preview-label">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</div><div class="pv-amt" id="pvAmt">28 450 ‚Ç¨</div></div>
          <div style="display:flex;gap:8px;margin-top:12px">
            <button class="btn btn-primary" style="font-size:13px" onclick="saveAmtColor()">‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            <button class="btn btn-secondary" style="font-size:13px" onclick="setAmtColor('#ffffff')">‚Ü∫ –°–±—Ä–æ—Å</button>
          </div>
        </div>

        <!-- CURRENCY -->
        <div class="settings-section">
          <h3>üí± –í–∞–ª—é—Ç–∞</h3>
          <div class="form-group"><label class="form-label">–í–∞–ª—é—Ç–∞</label>
            <select class="form-select" id="settingCurrency" onchange="updateAmtPreview(document.getElementById('amtPicker').value||amountColor)">
              <option value="‚Ç¨">‚Ç¨ –ï–≤—Ä–æ</option>
              <option value="$">$ –î–æ–ª–ª–∞—Ä</option>
              <option value="¬£">¬£ –§—É–Ω—Ç</option>
              <option value="‚Ç¥">‚Ç¥ –ì—Ä–∏–≤–Ω–∞</option>
              <option value="‚Ç∏">‚Ç∏ –¢–µ–Ω–≥–µ</option>
              <option value="z≈Ç">z≈Ç –ó–ª–æ—Ç—ã–π</option>
              <option value="‚Ç£">‚Ç£ –§—Ä–∞–Ω–∫</option>
            </select>
          </div>
          <button class="btn btn-primary" style="font-size:13px" onclick="saveCurrencySetting()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>

        <!-- LANGUAGE -->
        <div class="settings-section">
          <h3 id="s_lang_h">üåê –ú–æ–≤–∞ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É</h3>
          <div class="form-group">
            <label class="form-label" id="s_lang_lbl">–ú–æ–≤–∞</label>
            <select class="form-select" id="settingLang">
              <option value="uk">üá∫üá¶ –£–∫—Ä–∞—ó–Ω—Å—å–∫–∞</option>
              <option value="ru">üá∑üá∫ –†—É—Å—Å–∫–∏–π</option>
              <option value="en">üá¨üáß English</option>
            </select>
          </div>
          <button class="btn btn-primary" style="font-size:13px" onclick="saveLangSetting()" id="s_lang_btn">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
        </div>

        <!-- DATA -->
        <div class="settings-section">
          <h3 id="s_data_h">üóÑ –î–∞–Ω–Ω—ã–µ</h3>
          <div class="settings-row">
            <div><div class="settings-row-label">Excel (.xlsx)</div><div class="settings-row-sub">–í—Å–µ —Ä–∞—Å—Ö–æ–¥—ã –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º</div></div>
            <button class="btn btn-green" style="width:auto;padding:10px 16px;font-size:13px" onclick="exportExcel()">üì•</button>
          </div>
          <div class="settings-row">
            <div><div class="settings-row-label">JSON —Ä–µ–∑–µ—Ä–≤</div><div class="settings-row-sub">–ü–æ–ª–Ω—ã–π –¥–∞–º–ø –¥–∞–Ω–Ω—ã—Ö</div></div>
            <button class="btn btn-secondary" style="width:auto;padding:10px 16px;font-size:13px" onclick="exportJSON()">üìã</button>
          </div>
          <div class="settings-row">
            <div><div class="settings-row-label" style="color:var(--red)">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</div><div class="settings-row-sub">–£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Ä–∞—Å—Ö–æ–¥—ã</div></div>
            <button class="btn btn-danger" style="width:auto;padding:10px 16px;font-size:13px" onclick="clearAll()">üóë</button>
          </div>
          <div class="settings-row">
            <div><div class="settings-row-label">üîí –°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</div><div class="settings-row-sub">–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 1234</div></div>
            <button class="btn btn-secondary" style="width:auto;padding:10px 16px;font-size:13px" onclick="showChangePassword()">–°–º–µ–Ω–∏—Ç—å</button>
          </div>
          <div class="settings-row">
            <div><div class="settings-row-label">üö™ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</div><div class="settings-row-sub">–í—ã–π—Ç–∏ –∏ –ø–æ–∫–∞–∑–∞—Ç—å —ç–∫—Ä–∞–Ω –ø–∞—Ä–æ–ª—è</div></div>
            <button class="btn btn-secondary" style="width:auto;padding:10px 16px;font-size:13px" onclick="lockApp()">–ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>
          </div>
        </div>
      </div>
    </div>

  </div><!-- /main-area -->

  <!-- BOTTOM NAV (mobile) -->
  <div class="bottom-nav" id="bottomNav">
    <div class="nav-item active" data-view="calendar" onclick="switchView('calendar')">
      <div class="nav-icon">üìÖ</div>
      <div class="nav-label" data-i18n="calendar">–ö–∞–ª–µ–Ω–¥–∞—Ä</div>
    </div>
    <div class="nav-item" data-view="charts" onclick="switchView('charts')">
      <div class="nav-icon">üìä</div>
      <div class="nav-label" data-i18n="analytics">–ê–Ω–∞–ª—ñ—Ç–∏–∫–∞</div>
    </div>
    <div class="nav-add">
      <button class="nav-add-btn" onclick="openAddModal()">Ôºã</button>
    </div>
    <div class="nav-item" data-view="plan" onclick="switchView('plan')">
      <div class="nav-icon">üéØ</div>
      <div class="nav-label" data-i18n="plan">–ü–ª–∞–Ω</div>
    </div>
    <div class="nav-item" data-view="settings" onclick="switchView('settings')">
      <div class="nav-icon">‚öôÔ∏è</div>
      <div class="nav-label" data-i18n="settings">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</div>
    </div>
  </div>

</div><!-- /app-body -->

<!-- FAB (desktop) -->
<div class="fab"><button class="fab-btn" onclick="openAddModal()">Ôºã</button></div>

<!-- ADD MODAL -->
<div class="modal-overlay" id="addModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <h2 id="addTitle">–î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥ <button class="modal-close" onclick="closeModal('addModal')">√ó</button></h2>
    <div class="form-group"><label class="form-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</label>
      <select class="form-select" id="expUser"></select>
    </div>
    <div class="form-group"><label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label><input class="form-input" id="expName" placeholder="–ü—Ä–æ–¥—É–∫—Ç—ã, –ê—Ä–µ–Ω–¥–∞..."></div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">–°—É–º–º–∞</label><input class="form-input" id="expAmount" type="number" placeholder="0" min="0" step="0.01" inputmode="decimal"></div>
      <div class="form-group"><label class="form-label">–î–∞—Ç–∞</label><input class="form-input" id="expDate" type="date"></div>
    </div>
    <div class="form-group"><label class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label><select class="form-select" id="expCat"></select></div>
    <div class="form-group"><label class="form-label">–ó–∞–º–µ—Ç–∫–∞</label><input class="form-input" id="expNote" placeholder="–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ..."></div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('addModal')">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-primary" onclick="saveExpense()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- BUDGET MODAL -->
<div class="modal-overlay" id="planModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <h2>–ë—é–¥–∂–µ—Ç –Ω–∞ –º–µ—Å—è—Ü <button class="modal-close" onclick="closeModal('planModal')">√ó</button></h2>
    <div id="budgetFields"></div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('planModal')">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-primary" onclick="saveBudgets()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- EXPENSE DETAIL BOTTOM SHEET -->
<div class="bottom-sheet" id="expDet">
  <div class="bs-overlay" onclick="closeDetail()"></div>
  <div class="bs-content">
    <div class="bs-handle"></div>
    <div class="det-name" id="dName"></div>
    <div class="det-cat" id="dCat"></div>
    <div class="det-amt" id="dAmt"></div>
    <div class="det-meta" id="dDate"></div>
    <div class="det-note" id="dNote"></div>
    <div class="det-user" id="dUser"></div>
    <div class="det-actions">
      <button class="det-btn" onclick="editFromDetail()" style="background:var(--surface2);color:var(--text2);border:1px solid var(--border)">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å</button>
      <button class="det-btn" onclick="deleteFromDetail()" style="background:rgba(255,107,107,.15);color:var(--red);border:1px solid rgba(255,107,107,.3)">üóë –£–¥–∞–ª–∏—Ç—å</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONSTANTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DEFAULT_CATS = {
  '–ñ–∏–ª—å—ë':       {icon:'üè†',color:'#6c8dfa',builtin:true},
  '–ï–¥–∞':         {icon:'üçî',color:'#4ecca3',builtin:true},
  '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç':   {icon:'üöó',color:'#ffa94d',builtin:true},
  '–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è': {icon:'üé¨',color:'#b197fc',builtin:true},
  '–ó–¥–æ—Ä–æ–≤—å–µ':    {icon:'üíä',color:'#ff87b2',builtin:true},
  '–î–µ—Ç–∏':        {icon:'üßí',color:'#ffd43b',builtin:true},
  '–ü—Ä–æ—á–µ–µ':      {icon:'üì¶',color:'#8892a4',builtin:true},
};
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  I18N ‚Äî TRANSLATIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const I18N = {
  uk: {
    // Nav
    calendar:'–ö–∞–ª–µ–Ω–¥–∞—Ä', analytics:'–ê–Ω–∞–ª—ñ—Ç–∏–∫–∞', plan:'–ü–ª–∞–Ω', settings:'–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è',
    // Settings sections
    s_users:'üë§ –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ', s_cats:'üè∑ –ö–∞—Ç–µ–≥–æ—Ä—ñ—ó', s_catcolors:'üé® –ö–æ–ª—å–æ—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ–π',
    s_amtcolor:'üí∞ –ö–æ–ª—ñ—Ä —Å—É–º', s_currency:'üí± –í–∞–ª—é—Ç–∞', s_data:'üóÑ –î–∞–Ω—ñ', s_lang:'üåê –ú–æ–≤–∞ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É',
    // Category actions
    new_cat:'–ù–æ–≤–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è', add_cat:'+ –î–æ–¥–∞—Ç–∏', reset_cats:'‚Ü∫ –°–∫–∏–Ω—É—Ç–∏',
    cat_name:'–ù–∞–∑–≤–∞', cat_icon:'–Ü–∫–æ–Ω–∫–∞', cat_color:'–ö–æ–ª—ñ—Ä', quick_color:'–®–≤–∏–¥–∫–∏–π –∫–æ–ª—ñ—Ä',
    // Amount color
    preview:'–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥', apply:'‚úÖ –ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏', reset:'‚Ü∫ –°–∫–∏–Ω—É—Ç–∏',
    // Currency
    save:'–ó–±–µ—Ä–µ–≥—Ç–∏',
    // Data
    excel_export:'Excel (.xlsx)', excel_sub:'–í—Å—ñ –≤–∏—Ç—Ä–∞—Ç–∏ –ø–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º',
    json_export:'JSON —Ä–µ–∑–µ—Ä–≤', json_sub:'–ü–æ–≤–Ω–∏–π –¥–∞–º–ø –¥–∞–Ω–∏—Ö',
    clear_all:'–û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å–µ', clear_sub:'–í–∏–¥–∞–ª–∏—Ç–∏ –≤—Å—ñ –≤–∏—Ç—Ä–∞—Ç–∏',
    change_pass:'üîí –ó–º—ñ–Ω–∏—Ç–∏ –ø–∞—Ä–æ–ª—å', change_pass_sub:'–ü–æ—Ç–æ—á–Ω–∏–π –ø–∞—Ä–æ–ª—å –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º: 1234',
    lock:'üö™ –ó–∞–±–ª–æ–∫—É–≤–∞—Ç–∏', lock_sub:'–í–∏–π—Ç–∏ —Ç–∞ –ø–æ–∫–∞–∑–∞—Ç–∏ –µ–∫—Ä–∞–Ω –ø–∞—Ä–æ–ª—è',
    change_btn:'–ó–º—ñ–Ω–∏—Ç–∏', lock_btn:'–ë–ª–æ–∫—É–≤–∞—Ç–∏',
    // Months
    months:['–°—ñ—á–µ–Ω—å','–õ—é—Ç–∏–π','–ë–µ—Ä–µ–∑–µ–Ω—å','–ö–≤—ñ—Ç–µ–Ω—å','–¢—Ä–∞–≤–µ–Ω—å','–ß–µ—Ä–≤–µ–Ω—å','–õ–∏–ø–µ–Ω—å','–°–µ—Ä–ø–µ–Ω—å','–í–µ—Ä–µ—Å–µ–Ω—å','–ñ–æ–≤—Ç–µ–Ω—å','–õ–∏—Å—Ç–æ–ø–∞–¥','–ì—Ä—É–¥–µ–Ω—å'],
    months_g:['—Å—ñ—á–Ω—è','–ª—é—Ç–æ–≥–æ','–±–µ—Ä–µ–∑–Ω—è','–∫–≤—ñ—Ç–Ω—è','—Ç—Ä–∞–≤–Ω—è','—á–µ—Ä–≤–Ω—è','–ª–∏–ø–Ω—è','—Å–µ—Ä–ø–Ω—è','–≤–µ—Ä–µ—Å–Ω—è','–∂–æ–≤—Ç–Ω—è','–ª–∏—Å—Ç–æ–ø–∞–¥–∞','–≥—Ä—É–¥–Ω—è'],
    days:['–ü–ù','–í–¢','–°–†','–ß–¢','–ü–¢','–°–ë','–ù–î'],
    // Built-in categories
    cats:{'–ñ–∏–ª—å—ë':'–ñ–∏—Ç–ª–æ','–ï–¥–∞':'–á–∂–∞','–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç':'–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç','–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è':'–†–æ–∑–≤–∞–≥–∏','–ó–¥–æ—Ä–æ–≤—å–µ':'–ó–¥–æ—Ä–æ–≤'—è','–î–µ—Ç–∏':'–î—ñ—Ç–∏','–ü—Ä–æ—á–µ–µ':'–Ü–Ω—à–µ'},
    // Modals
    add_expense:'–î–æ–¥–∞—Ç–∏ –≤–∏—Ç—Ä–∞—Ç—É', edit_expense:'–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –≤–∏—Ç—Ä–∞—Ç—É',
    expense_name:'–ù–∞–∑–≤–∞', expense_amount:'–°—É–º–∞', expense_cat:'–ö–∞—Ç–µ–≥–æ—Ä—ñ—è',
    expense_date:'–î–∞—Ç–∞', expense_note:'–ù–æ—Ç–∞—Ç–∫–∞', expense_user:'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á',
    cancel:'–°–∫–∞—Å—É–≤–∞—Ç–∏', delete_btn:'–í–∏–¥–∞–ª–∏—Ç–∏',
    // Toast / errors
    err_name:'‚ùå –í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É', err_amount:'‚ùå –í–≤–µ–¥—ñ—Ç—å —Å—É–º—É',
    saved:'‚úÖ –ó–±–µ—Ä–µ–∂–µ–Ω–æ', deleted:'üóë –í–∏–¥–∞–ª–µ–Ω–æ',
    currency_saved:'‚úÖ –í–∞–ª—é—Ç—É –∑–±–µ—Ä–µ–∂–µ–Ω–æ', color_saved:'‚úÖ –ö–æ–ª—ñ—Ä –æ–Ω–æ–≤–ª–µ–Ω–æ',
    // Plan
    plan_budget:'–ë—é–¥–∂–µ—Ç', plan_spent:'–í–∏—Ç—Ä–∞—á–µ–Ω–æ', plan_left:'–ó–∞–ª–∏—à–æ–∫',
    // Shared
    shared:'–°–ø—ñ–ª—å–Ω—ñ', total:'–ó–∞–≥–∞–ª–æ–º',
    // Login screen
    select_account:'–í–∏–±–µ—Ä—ñ—Ç—å –∞–∫–∞—É–Ω—Ç', who_are_you:'–•—Ç–æ –≤–∏?', enter_password:'–í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å',
    loading:'–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...',
  },
  ru: {
    calendar:'–ö–∞–ª–µ–Ω–¥–∞—Ä—å', analytics:'–ê–Ω–∞–ª–∏—Ç–∏–∫–∞', plan:'–ü–ª–∞–Ω', settings:'–ù–∞—Å—Ç—Ä–æ–π–∫–∏',
    s_users:'üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏', s_cats:'üè∑ –ö–∞—Ç–µ–≥–æ—Ä–∏–∏', s_catcolors:'üé® –¶–≤–µ—Ç–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π',
    s_amtcolor:'üí∞ –¶–≤–µ—Ç —Å—É–º–º', s_currency:'üí± –í–∞–ª—é—Ç–∞', s_data:'üóÑ –î–∞–Ω–Ω—ã–µ', s_lang:'üåê –Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞',
    new_cat:'–ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è', add_cat:'+ –î–æ–±–∞–≤–∏—Ç—å', reset_cats:'‚Ü∫ –°–±—Ä–æ—Å–∏—Ç—å',
    cat_name:'–ù–∞–∑–≤–∞–Ω–∏–µ', cat_icon:'–ò–∫–æ–Ω–∫–∞', cat_color:'–¶–≤–µ—Ç', quick_color:'–ë—ã—Å—Ç—Ä—ã–π —Ü–≤–µ—Ç',
    preview:'–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä', apply:'‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç—å', reset:'‚Ü∫ –°–±—Ä–æ—Å',
    save:'–°–æ—Ö—Ä–∞–Ω–∏—Ç—å',
    excel_export:'Excel (.xlsx)', excel_sub:'–í—Å–µ —Ä–∞—Å—Ö–æ–¥—ã –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º',
    json_export:'JSON —Ä–µ–∑–µ—Ä–≤', json_sub:'–ü–æ–ª–Ω—ã–π –¥–∞–º–ø –¥–∞–Ω–Ω—ã—Ö',
    clear_all:'–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë', clear_sub:'–£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Ä–∞—Å—Ö–æ–¥—ã',
    change_pass:'üîí –°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å', change_pass_sub:'–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 1234',
    lock:'üö™ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å', lock_sub:'–í—ã–π—Ç–∏ –∏ –ø–æ–∫–∞–∑–∞—Ç—å —ç–∫—Ä–∞–Ω –ø–∞—Ä–æ–ª—è',
    change_btn:'–°–º–µ–Ω–∏—Ç—å', lock_btn:'–ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å',
    months:['–Ø–Ω–≤–∞—Ä—å','–§–µ–≤—Ä–∞–ª—å','–ú–∞—Ä—Ç','–ê–ø—Ä–µ–ª—å','–ú–∞–π','–ò—é–Ω—å','–ò—é–ª—å','–ê–≤–≥—É—Å—Ç','–°–µ–Ω—Ç—è–±—Ä—å','–û–∫—Ç—è–±—Ä—å','–ù–æ—è–±—Ä—å','–î–µ–∫–∞–±—Ä—å'],
    months_g:['—è–Ω–≤–∞—Ä—è','—Ñ–µ–≤—Ä–∞–ª—è','–º–∞—Ä—Ç–∞','–∞–ø—Ä–µ–ª—è','–º–∞—è','–∏—é–Ω—è','–∏—é–ª—è','–∞–≤–≥—É—Å—Ç–∞','—Å–µ–Ω—Ç—è–±—Ä—è','–æ–∫—Ç—è–±—Ä—è','–Ω–æ—è–±—Ä—è','–¥–µ–∫–∞–±—Ä—è'],
    days:['–ü–ù','–í–¢','–°–†','–ß–¢','–ü–¢','–°–ë','–í–°'],
    cats:{'–ñ–∏–ª—å—ë':'–ñ–∏–ª—å—ë','–ï–¥–∞':'–ï–¥–∞','–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç':'–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç','–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è':'–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è','–ó–¥–æ—Ä–æ–≤—å–µ':'–ó–¥–æ—Ä–æ–≤—å–µ','–î–µ—Ç–∏':'–î–µ—Ç–∏','–ü—Ä–æ—á–µ–µ':'–ü—Ä–æ—á–µ–µ'},
    add_expense:'–î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥', edit_expense:'–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–∞—Å—Ö–æ–¥',
    expense_name:'–ù–∞–∑–≤–∞–Ω–∏–µ', expense_amount:'–°—É–º–º–∞', expense_cat:'–ö–∞—Ç–µ–≥–æ—Ä–∏—è',
    expense_date:'–î–∞—Ç–∞', expense_note:'–ó–∞–º–µ—Ç–∫–∞', expense_user:'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
    cancel:'–û—Ç–º–µ–Ω–∞', delete_btn:'–£–¥–∞–ª–∏—Ç—å',
    err_name:'‚ùå –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ', err_amount:'‚ùå –í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É',
    saved:'‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ', deleted:'üóë –£–¥–∞–ª–µ–Ω–æ',
    currency_saved:'‚úÖ –í–∞–ª—é—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞', color_saved:'‚úÖ –¶–≤–µ—Ç –æ–±–Ω–æ–≤–ª—ë–Ω',
    plan_budget:'–ë—é–¥–∂–µ—Ç', plan_spent:'–ü–æ—Ç—Ä–∞—á–µ–Ω–æ', plan_left:'–û—Å—Ç–∞—Ç–æ–∫',
    shared:'–û–±—â–∏–µ', total:'–ò—Ç–æ–≥–æ',
    select_account:'–í—ã–±–µ—Ä–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç', who_are_you:'–ö—Ç–æ –≤—ã?', enter_password:'–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å',
    loading:'–ó–∞–≥—Ä—É–∑–∫–∞...',
  },
  en: {
    calendar:'Calendar', analytics:'Analytics', plan:'Plan', settings:'Settings',
    s_users:'üë§ Users', s_cats:'üè∑ Categories', s_catcolors:'üé® Category colors',
    s_amtcolor:'üí∞ Amount color', s_currency:'üí± Currency', s_data:'üóÑ Data', s_lang:'üåê Language',
    new_cat:'New category', add_cat:'+ Add', reset_cats:'‚Ü∫ Reset',
    cat_name:'Name', cat_icon:'Icon', cat_color:'Color', quick_color:'Quick color',
    preview:'Preview', apply:'‚úÖ Apply', reset:'‚Ü∫ Reset',
    save:'Save',
    excel_export:'Excel (.xlsx)', excel_sub:'All expenses by users',
    json_export:'JSON backup', json_sub:'Full data dump',
    clear_all:'Clear all', clear_sub:'Delete all expenses',
    change_pass:'üîí Change password', change_pass_sub:'Default password: 1234',
    lock:'üö™ Lock', lock_sub:'Sign out and show password screen',
    change_btn:'Change', lock_btn:'Lock',
    months:['January','February','March','April','May','June','July','August','September','October','November','December'],
    months_g:['January','February','March','April','May','June','July','August','September','October','November','December'],
    days:['MO','TU','WE','TH','FR','SA','SU'],
    cats:{'–ñ–∏–ª—å—ë':'Housing','–ï–¥–∞':'Food','–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç':'Transport','–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è':'Entertainment','–ó–¥–æ—Ä–æ–≤—å–µ':'Health','–î–µ—Ç–∏':'Children','–ü—Ä–æ—á–µ–µ':'Other'},
    add_expense:'Add expense', edit_expense:'Edit expense',
    expense_name:'Name', expense_amount:'Amount', expense_cat:'Category',
    expense_date:'Date', expense_note:'Note', expense_user:'User',
    cancel:'Cancel', delete_btn:'Delete',
    err_name:'‚ùå Enter name', err_amount:'‚ùå Enter amount',
    saved:'‚úÖ Saved', deleted:'üóë Deleted',
    currency_saved:'‚úÖ Currency saved', color_saved:'‚úÖ Color updated',
    plan_budget:'Budget', plan_spent:'Spent', plan_left:'Remaining',
    shared:'Shared', total:'Total',
    select_account:'Select account', who_are_you:'Who are you?', enter_password:'Enter password',
    loading:'Loading...',
  },
};

// Active language ‚Äî loaded from cfg or default UA
let lang = 'uk';
function t(key){ return (I18N[lang] && I18N[lang][key]) || (I18N['uk'][key]) || key; }

const MONTHS   = ['–Ø–Ω–≤–∞—Ä—å','–§–µ–≤—Ä–∞–ª—å','–ú–∞—Ä—Ç','–ê–ø—Ä–µ–ª—å','–ú–∞–π','–ò—é–Ω—å','–ò—é–ª—å','–ê–≤–≥—É—Å—Ç','–°–µ–Ω—Ç—è–±—Ä—å','–û–∫—Ç—è–±—Ä—å','–ù–æ—è–±—Ä—å','–î–µ–∫–∞–±—Ä—å'];
const MONTHS_G = ['—è–Ω–≤–∞—Ä—è','—Ñ–µ–≤—Ä–∞–ª—è','–º–∞—Ä—Ç–∞','–∞–ø—Ä–µ–ª—è','–º–∞—è','–∏—é–Ω—è','–∏—é–ª—è','–∞–≤–≥—É—Å—Ç–∞','—Å–µ–Ω—Ç—è–±—Ä—è','–æ–∫—Ç—è–±—Ä—è','–Ω–æ—è–±—Ä—è','–¥–µ–∫–∞–±—Ä—è'];
const DAYS     = ['–ü–ù','–í–¢','–°–†','–ß–¢','–ü–¢','–°–ë','–í–°'];
// Dynamic getters ‚Äî return translated versions when lang is set
function getMonths()  { return window._MONTHS   || MONTHS;   }
function getMonthsG() { return window._MONTHS_G || MONTHS_G; }
function getDays()    { return window._DAYS      || DAYS;     }
const PALETTE_COLORS = ['#6c8dfa','#4ecca3','#ffa94d','#b197fc','#ff87b2','#ffd43b','#ff6b6b','#a78bfa','#34d399','#f472b6','#fb923c','#38bdf8','#e879f9','#facc15','#4ade80'];
const EMOJI_LIST = ['üè†','üçî','üöó','üé¨','üíä','üßí','üì¶','üõí','üí™','üéÆ','‚úàÔ∏è','üéì','üíº','üêæ','üåø','üéÅ','üç∑','‚òï','üéµ','üíà','üèãÔ∏è','üõçÔ∏è','üè•','üì±','üíª','üîß','üé®','üìö','üåç','üèñÔ∏è','üçï','üöÄ','üí°','üé™','üê∂','üå∫','üéØ','üíé','üè¶','üöø','‚öΩ','üé∏','üç∞','üß¥','üßπ','üöÅ','üõû','üåô','‚≠ê','üîë'];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FIREBASE META CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Accounts and users are managed in the admin panel (finflow-admin.html)
// and stored in Firebase under finflow_meta/
// This app reads them on startup to build the login screen.
const FB_CONFIG = {
  apiKey: "AIzaSyBZ1b6yf1WQbhZ7lhIbeYw_fKc4k88mmFc",
  authDomain: "family-budget-32149.firebaseapp.com",
  databaseURL: "https://family-budget-32149-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "family-budget-32149",
  storageBucket: "family-budget-32149.firebasestorage.app",
  messagingSenderId: "1015461302295",
  appId: "1:1015461302295:web:835d7a14a852c224534c52"
};
const FB_URL_PRO = FB_CONFIG.databaseURL;
const META_REF    = 'finflow_meta'; // where admin panel stores accounts/users

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SESSION STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _session = {
  accId:    null,   // e.g. 'family-bogdan'
  userId:   null,   // e.g. 'bogdan'
  userData: null,   // { name, password, role, color, login }
  accData:  null,   // { name, color, users:{} }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SAFE STORAGE ‚Äî prefix per account+user
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Each account+user combo gets its own isolated localStorage namespace
let STORE_PREFIX = 'ff_none:'; // set in startApp() after login
const _mem = {};
const store = {
  get(k){ try{ return localStorage.getItem(STORE_PREFIX+k); }catch(e){ return _mem[STORE_PREFIX+k]||null; } },
  set(k,v){ try{ localStorage.setItem(STORE_PREFIX+k,v); }catch(e){} _mem[STORE_PREFIX+k]=v; },
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATE ‚Äî initialized in startApp() after login
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let allExpenses = [];
let budgets     = {};
let cfg         = {};
let CATS        = {};
let USERS       = {};
let currency    = '‚Ç¨';
let amountColor = '#ffffff';

let activeUser   = null; // set to current userId after login
let activeFilter = null;
let currentDate  = new Date();
let currentView  = 'calendar';
let editingId    = null;
let detailId     = null;
let selectedNewCatEmoji = 'üè∑';

// Firebase state
let fbApp = null, fbDb = null, fbRef = null, fbConnected = false, fbRoom = '';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  startApp() ‚Äî called after successful login
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startApp(accId, userId, accData, userData){
  // 1. Save session
  _session = { accId, userId, userData, accData };
  STORE_PREFIX = 'ffpro_' + accId + '_' + userId + ':';

  // 2. Save session token (24h)
  const APP_VER = 'pro1';
  try{
    sessionStorage.setItem('ffpro_active_acc', accId);
    sessionStorage.setItem('ffpro_active_user', userId);
    localStorage.setItem(STORE_PREFIX+'sess',    Date.now().toString());
    localStorage.setItem(STORE_PREFIX+'sess_ver', APP_VER);
  }catch(e){}

  // 3. Load this account's data from storage
  CATS  = JSON.parse(JSON.stringify(DEFAULT_CATS));

  // Build USERS from account's user list
  USERS = {};
  Object.entries(accData.users || {}).forEach(([uid, u])=>{
    USERS[uid] = { name: u.name || uid, color: u.color || '#6c8dfa' };
  });
  // Ensure at least 2 CSS user vars
  const userIds = Object.keys(USERS);
  if(userIds[0]) document.documentElement.style.setProperty('--u1', USERS[userIds[0]].color);
  if(userIds[1]) document.documentElement.style.setProperty('--u2', USERS[userIds[1]].color);

  const exp = store.get('ff_exp');
  const bud = store.get('ff_bud');
  const c   = store.get('ff_cfg');
  allExpenses = JSON.parse(exp && exp!=='[]' ? exp : '[]');
  budgets     = JSON.parse(bud && bud!=='{}' ? bud : '{}');
  cfg         = JSON.parse(c   && c!=='{}'   ? c   : '{}');

  // 4. Apply saved config
  if(cfg.customCats) Object.entries(cfg.customCats).forEach(([n,d])=>{ CATS[n]={...d,builtin:false}; });
  if(cfg.catColors)  Object.keys(cfg.catColors).forEach(k=>{ if(CATS[k]) CATS[k].color=cfg.catColors[k]; });
  // Apply saved category order
  if(cfg.catOrder && Array.isArray(cfg.catOrder)){
    const ordered = {};
    cfg.catOrder.forEach(n=>{ if(CATS[n]) ordered[n]=CATS[n]; });
    // Add any new cats not in saved order
    Object.keys(CATS).forEach(n=>{ if(!ordered[n]) ordered[n]=CATS[n]; });
    Object.keys(CATS).forEach(n=>delete CATS[n]);
    Object.assign(CATS, ordered);
  }
  if(cfg.users)      Object.entries(cfg.users).forEach(([uid,d])=>{ if(USERS[uid]){ if(d.name)USERS[uid].name=d.name; if(d.color)USERS[uid].color=d.color; }});
  currency    = cfg.currency    || '‚Ç¨';
  amountColor = cfg.amountColor || '#ffffff';
  lang = cfg.lang || 'uk';
  document.documentElement.style.setProperty('--amount-color', amountColor);

  // 5. Set active user to logged-in user
  activeUser = userId;

  // 6. Default budgets only (no seed expenses ‚Äî they race with Firebase)
  if(!Object.keys(budgets).length){
    budgets={'–ñ–∏–ª—å—ë':1100,'–ï–¥–∞':400,'–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç':200,'–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è':100,'–ó–¥–æ—Ä–æ–≤—å–µ':150,'–î–µ—Ç–∏':100,'–ü—Ä–æ—á–µ–µ':80};
    saveBud();
  }

  // 7. Firebase auto-connect using accId as room
  DEFAULT_FB_URL  = FB_URL_PRO;
  DEFAULT_FB_ROOM = accId; // each account has its own room
  const fbUrlToUse  = cfg.fbUrl  || DEFAULT_FB_URL;
  const fbRoomToUse = cfg.fbRoom || DEFAULT_FB_ROOM;
  const fbUrlEl  = document.getElementById('fbUrl');
  const fbRoomEl = document.getElementById('fbRoom');
  if(fbUrlEl)  fbUrlEl.value  = fbUrlToUse;
  if(fbRoomEl) fbRoomEl.value = fbRoomToUse;

  // 8. Update top bar to show user name
  const syncBar = document.querySelector('.sync-bar');
  if(syncBar){
    // Add user badge to right of sync bar
    if(!document.getElementById('userBadge')){
      const badge = document.createElement('div');
      badge.id = 'userBadge';
      badge.style.cssText = 'display:flex;align-items:center;gap:6px;cursor:pointer;';
      badge.title = '–í—ã–π—Ç–∏';
      badge.onclick = lockApp;
      badge.innerHTML = `
        <div style="width:20px;height:20px;border-radius:6px;background:${userData.color||'#6c8dfa'};display:flex;align-items:center;justify-content:center;font-family:'Syne',sans-serif;font-weight:800;font-size:9px;color:#fff;">${(userData.name||userId)[0].toUpperCase()}</div>
        <span style="font-size:11px;color:var(--text3);">${userData.name||userId}</span>
        <span style="font-size:10px;color:var(--text3);opacity:.5;">‚éã</span>
      `;
      syncBar.style.justifyContent = 'space-between';
      syncBar.appendChild(badge);
    }
  }

  // 9. Restrict UI by role
  const role = userData.role || 'editor';
  if(role === 'viewer'){
    // Hide all add/edit buttons for viewers
    document.querySelectorAll('.nav-add-btn, .fab-btn, .hbtn[onclick*="openAdd"]').forEach(el=>{ el.style.display='none'; });
  } else {
    // Make sure add buttons are visible for editors
    document.querySelectorAll('.nav-add-btn, .fab-btn').forEach(el=>{ el.style.display=''; });
  }

  // 10. Connect Firebase immediately ‚Äî auth handled inside initFirebase
  try{ initFirebase(fbUrlToUse, fbRoomToUse); }catch(e){
    setSyncStatus('offline','–û—à–∏–±–∫–∞: '+e.message);
  }

  // Apply language on startup
  applyLang(lang, false);

  try{
    initEmojiPicker();
    initColorPalette();
    renderUserSwitcher();
    buildSidebarCats();
    updateSidebarUsers();
    updateBadges();
    renderCalendar();
  }catch(err){
    console.error('startApp render error:', err);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FIREBASE SYNC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function connectFirebase(){
  const url=(document.getElementById('fbUrl').value.trim()) || DEFAULT_FB_URL;
  const room=(document.getElementById('fbRoom').value.trim()) || DEFAULT_FB_ROOM;
  if(!url.startsWith('https://')){showToast('‚ùå URL –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å https://');return;}
  // Save only if differs from default (keep cfg clean)
  if(url !== DEFAULT_FB_URL || room !== DEFAULT_FB_ROOM){
    cfg.fbUrl=url; cfg.fbRoom=room; saveCfg();
  }
  setSyncStatus('syncing','–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...');
  try{initFirebase(url,room);}catch(e){showToast('‚ùå '+e.message);setSyncStatus('offline','–û—à–∏–±–∫–∞: '+e.message);}
}

function initFirebase(url, room){
  if(!window.firebase || typeof firebase.initializeApp !== 'function'){
    showToast('‚ùå Firebase SDK –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.');
    setSyncStatus('offline','SDK –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
    return;
  }
  // Reuse ff_meta app ‚Äî it's already authenticated anonymously by loadAccounts
  // This avoids creating a new app that needs to re-authenticate
  try{ fbApp = firebase.app('ff_meta'); }catch(e){
    // ff_meta not available ‚Äî create fresh app with full config
    try{
      firebase.apps.slice().forEach(a=>{ try{a.delete();}catch(e){} });
    }catch(e){}
    const fbCfg = url === FB_URL_PRO ? FB_CONFIG : {databaseURL: url};
    try{ fbApp = firebase.initializeApp(fbCfg); }
    catch(e){ fbApp = firebase.app(); }
  }
  fbDb = fbApp.database();
  fbRoom = room;
  fbRef = fbDb.ref('finflow/' + room);

  setSyncStatus('syncing','–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...');

  function onFbConnected(){
    fbConnected = true;
    setSyncStatus('online','–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ ‚úì');
    document.getElementById('fbStatus').className='firebase-status connected';
    document.getElementById('fbStatus').innerHTML='<span>‚óè</span>&nbsp;–ü–æ–¥–∫–ª—é—á–µ–Ω–æ ¬∑ ' + fbRoom;
    document.getElementById('btnDisconnect').style.display='block';
  }

  // Authenticate anonymously BEFORE attaching listeners
  // This ensures auth != null when Rules are strict
  const startListeners = () => {

  // ‚îÄ‚îÄ Listener 1: expenses (real-time, source of truth) ‚îÄ‚îÄ
  fbRef.child('expenses').on('value', snap => {
    if(_receivingRemote) return;
    _receivingRemote = true;
    const data = snap.val();
    // Only update if Firebase actually has data OR we have nothing locally
    // This prevents a brief null snap from wiping real local expenses
    if(data){
      allExpenses = Object.values(data);
      store.set('ff_exp', JSON.stringify(allExpenses));
    } else if(!allExpenses.length){
      // Firebase empty and nothing local ‚Äî start fresh
      allExpenses = [];
      store.set('ff_exp', '[]');
    }
    // If data===null but we have local expenses ‚Äî keep local until Firebase confirms
    renderCalendar();
    updateBadges();
    if(currentView==='charts') renderCharts();
    if(currentView==='plan')   renderPlan();
    _receivingRemote = false;
    onFbConnected();
  }, err=>{ setSyncStatus('offline','–û—à–∏–±–∫–∞: '+err.message); });

  // ‚îÄ‚îÄ Listener 2: budgets ‚îÄ‚îÄ
  fbRef.child('budgets').on('value', snap => {
    if(_receivingRemote) return;
    const data = snap.val();
    if(data && Object.keys(data).length){
      budgets = data;
      store.set('ff_bud', JSON.stringify(budgets));
      if(currentView==='plan')   renderPlan();
      if(currentView==='charts') renderCharts();
    }
  });

  // ‚îÄ‚îÄ Listener 3: cfg ‚Äî categories, users, colors (real-time) ‚îÄ‚îÄ
  fbRef.child('cfg').on('value', snap => {
    if(_receivingRemote) return;
    _receivingRemote = true;
    const remoteCfg = snap.val();
    if(remoteCfg){
      // Apply users
      if(remoteCfg.users){
        cfg.users = remoteCfg.users;
        Object.entries(remoteCfg.users).forEach(([uid,d])=>{
          if(USERS[uid]){ if(d.name)USERS[uid].name=d.name; if(d.color)USERS[uid].color=d.color; }
        });
        const uids=Object.keys(USERS);
        if(uids[0]) document.documentElement.style.setProperty('--u1',USERS[uids[0]].color);
        if(uids[1]) document.documentElement.style.setProperty('--u2',USERS[uids[1]].color);
        updateSidebarUsers();
      }
      // Apply custom categories
      if(remoteCfg.customCats){
        cfg.customCats = remoteCfg.customCats;
        Object.entries(remoteCfg.customCats).forEach(([n,d])=>{
          CATS[n] = {...d, builtin:false};
        });
        // Remove cats deleted on remote
        Object.keys(CATS).forEach(n=>{
          if(!CATS[n].builtin && !remoteCfg.customCats[n]) delete CATS[n];
        });
        buildSidebarCats();
      }
      // Apply cat colors
      if(remoteCfg.catColors){
        cfg.catColors = remoteCfg.catColors;
        Object.keys(remoteCfg.catColors).forEach(c=>{ if(CATS[c]) CATS[c].color=remoteCfg.catColors[c]; });
      }
      // Apply currency & amount color
      if(remoteCfg.currency)    { currency=remoteCfg.currency; cfg.currency=currency; }
      if(remoteCfg.amountColor) { amountColor=remoteCfg.amountColor; cfg.amountColor=amountColor; document.documentElement.style.setProperty('--amount-color',amountColor); }
      
      store.set('ff_cfg', JSON.stringify(cfg));
      renderCalendar();
      if(currentView==='settings') renderSettingsUI();
    }
    _receivingRemote = false;
  });

  // Presence detection
  let _connectedOnce = false;
  let _offlineTimer = null;
  fbDb.ref('.info/connected').on('value', snap => {
    if(snap.val()){
      _connectedOnce = true;
      if(_offlineTimer){ clearTimeout(_offlineTimer); _offlineTimer=null; }
      setSyncStatus('online','–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ ‚úì');
      pushToFirebaseIfEmpty();
    } else if(_connectedOnce){
      // Only show offline if we were connected before (not on initial load)
      _offlineTimer = setTimeout(()=>{
        setSyncStatus('offline','–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è ‚Äî —Ä–∞–±–æ—Ç–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ');
      }, 5000);
    }
  });

  }; // end startListeners

  // Sign in anonymously then start listeners
  try{
    const auth = fbApp.auth();
    let _started = false;
    const go = () => { if(!_started){ _started=true; startListeners(); } };

    if(auth.currentUser){
      go();
    } else {
      // onAuthStateChanged fires as soon as token is ready ‚Äî more reliable than .then()
      const unsub = auth.onAuthStateChanged(user => {
        if(user){ unsub(); go(); }
      });
      // LOCAL persistence ‚Äî token cached in localStorage, no re-auth on each open
      auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
        .then(()=> auth.signInAnonymously())
        .catch(e=>{
          console.warn('Auth failed, starting anyway:', e.message);
          try{ unsub(); }catch(e2){}
          go();
        });
      // Safety: if auth hangs 6s ‚Äî start anyway
      setTimeout(()=>{ go(); }, 6000);
    }
  } catch(e){
    // No auth SDK ‚Äî start listeners directly
    startListeners();
  }
}

function mergeExpenses(local, remote){
  const map = {};
  // ID-based merge: latest timestamp wins
  local.forEach(e => { if(e && e.id) map[e.id] = e; });
  remote.forEach(e => { if(e && e.id){
    if(!map[e.id] || (e.ts||0) > (map[e.id].ts||0)) map[e.id] = e;
  }});
  return Object.values(map);
}

function pushToFirebase(){
  if(!fbRef || !fbConnected) return;
  const expsObj = {};
  allExpenses.forEach(e => { expsObj[e.id.toString().replace(/\./g,'_')] = e; });
  // set() so deletions propagate (update() never deletes keys)
  fbRef.child('expenses').set(expsObj).catch(e=>{
    setSyncStatus('offline','–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏: ' + e.message);
  });
  fbRef.child('budgets').set(budgets);
  // cfg pushed separately by saveCfg() ‚Äî don't double-push here
}

let _firstConnect = true;
function pushToFirebaseIfEmpty(){
  // On first connect: only push if Firebase has no expenses AND we have local data
  // Never push an empty array ‚Äî that would wipe real data for other users on the same account
  if(!fbRef || !fbConnected) return;
  if(!allExpenses.length) return; // nothing local to push ‚Äî wait for Firebase listener
  fbRef.child('expenses').once('value').then(snap=>{
    if(!snap.val()) {
      // Firebase truly empty AND we have local data ‚Äî push it
      pushToFirebase();
    }
    // else: Firebase has data, it will come via the listener ‚Äî don't overwrite
    _firstConnect = false;
  });
}

function setSyncStatus(type, text){
  const bar = document.getElementById('syncBar');
  const dot = bar.querySelector('.sync-dot');
  bar.className = 'sync-bar ' + type;
  document.getElementById('syncText').textContent = text;
  dot.className = 'sync-dot' + (type==='syncing'?' pulse':'');
}

function disconnectFirebase(){
  if(fbRef){ fbRef.off(); fbRef=null; }
  fbConnected=false; fbApp=null; fbDb=null;
  delete cfg.fbUrl; delete cfg.fbRoom; saveCfg();
  setSyncStatus('setup','–õ–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º ‚Äî –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ Firebase –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏');
  document.getElementById('fbStatus').className='firebase-status disconnected';
  document.getElementById('fbStatus').innerHTML='<span>‚óè</span>&nbsp;–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ';
  document.getElementById('btnDisconnect').style.display='none';
  showToast('üîå –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞');
}

// Firebase URL and room ‚Äî set dynamically in startApp() based on logged-in account
let DEFAULT_FB_URL  = FB_URL_PRO;
let DEFAULT_FB_ROOM = 'default'; // overridden by startApp()

// Firebase auto-connect is handled in startApp()

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PERSISTENCE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _receivingRemote = false; // flag to avoid echo-loop when receiving Firebase data
function save()   { store.set('ff_exp', JSON.stringify(allExpenses)); if(fbConnected && !_receivingRemote) pushToFirebase(); }
function saveBud(){ store.set('ff_bud', JSON.stringify(budgets)); if(fbConnected && !_receivingRemote) pushToFirebase(); }
function saveCfg(){ 
  store.set('ff_cfg', JSON.stringify(cfg)); 
  // Push cfg to Firebase separately ‚Äî doesn't trigger expense re-sync
  if(fbRef && fbConnected && !_receivingRemote){
    fbRef.child('cfg').set({
      users:      cfg.users      || {},
      customCats: cfg.customCats || {},
      catColors:  cfg.catColors  || {},
      currency:   cfg.currency   || currency,
      amountColor:cfg.amountColor|| amountColor,
    }).catch(e=>console.warn('cfg push failed:', e));
  }
}
function fmt(n)   { return Number(n).toLocaleString('ru-RU') + '\u00A0' + currency; }

function showToast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),3000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  LAYOUT DETECTION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function isDesktop(){ return window.innerWidth >= 768; }
function applyLayout(){
  const sd = document.getElementById('sidebarDesktop');
  if(isDesktop()){
    sd.style.display='flex';
    sd.style.flexDirection='column';
  } else {
    sd.style.display='none';
  }
}
applyLayout();
window.addEventListener('resize', applyLayout);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  USER SWITCHER (dynamic)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderUserSwitcher(){
  const sw=document.getElementById('userSwitcher');
  const sdList=document.getElementById('sdUsersList');
  const userIds=Object.keys(USERS);

  // Mobile pills
  if(sw){
    const pills=userIds.map((uid,i)=>{
      const u=USERS[uid];
      const isActive=uid===activeUser;
      return `<div class="usr-pill${isActive?' active':''}" id="pill-${uid}" onclick="setActiveUser('${uid}')">
        <div class="usr-av" id="pilAv-${uid}" style="background:${u.color}">${u.name[0]}</div>
        <div class="usr-info">
          <div class="usr-name" id="pilName-${uid}">${u.name}</div>
          <div class="usr-amt" id="pilAmt-${uid}">0 ${currency}</div>
        </div>
        <div class="usr-badge" id="pilBadge-${uid}" style="background:${u.color}">0</div>
      </div>`;
    }).join('');
    const sharedActive=activeUser==='shared';
    sw.innerHTML=pills+`<div class="usr-sum${sharedActive?' active':''}" id="pill-shared" onclick="setActiveUser('shared')">
      <div class="usr-sum-icon">‚àë</div>
      <div class="usr-sum-info">
        <div class="usr-sum-label">–ò—Ç–æ–≥–æ</div>
        <div class="usr-sum-val" id="pilSum">0 ${currency}</div>
      </div>
    </div>`;
  }

  // Desktop sidebar
  if(sdList){
    const sdItems=userIds.map((uid,i)=>{
      const u=USERS[uid];
      const cssVar=i===0?'var(--u1)':'var(--u2)';
      const isActive=uid===activeUser;
      return `<div class="sd-item${isActive?' active':''}" id="sdTab-${uid}" onclick="setActiveUser('${uid}')">
        <div style="width:28px;height:28px;border-radius:8px;background:${u.color};display:flex;align-items:center;justify-content:center;font-family:'Syne',sans-serif;font-weight:800;font-size:12px;color:white" id="sdAv-${uid}">${u.name[0]}</div>
        <div><div id="sdName-${uid}" style="font-size:13px;font-weight:600">${u.name}</div><div id="sdBadge-${uid}" style="font-size:10px;color:var(--text3)">0 ${currency}</div></div>
      </div>`;
    }).join('');
    const sharedActive=activeUser==='shared';
    sdList.innerHTML=sdItems+`<div class="sd-item${sharedActive?' active':''}" id="sdTab-shared" onclick="setActiveUser('shared')">
      <div style="width:28px;height:28px;border-radius:8px;background:var(--shared);display:flex;align-items:center;justify-content:center;font-family:'Syne',sans-serif;font-weight:800;font-size:14px;color:white">‚àë</div>
      <div><div style="font-size:13px;font-weight:600">–û–±—â–∏–π</div><div id="sdBadge-shared" style="font-size:10px;color:var(--text3)">0 ${currency}</div></div>
    </div>`;
  }
}


function setActiveUser(u){
  activeUser=u;
  const dynamicIds = [...Object.keys(USERS), 'shared'];
  dynamicIds.forEach(id=>{
    const pill=document.getElementById('pill-'+id);
    if(pill) pill.classList.toggle('active',id===u);
    const sdtab=document.getElementById('sdTab-'+id);
    if(sdtab) sdtab.classList.toggle('active',id===u);
  });
  updateBadges(); renderCalendar();
  if(currentView==='charts') renderCharts();
  if(currentView==='plan')   renderPlan();
}
function getExpenses(user){ 
  if(user==='shared') return allExpenses;
  // Normalise: treat missing/null user as first user in USERS
  const firstUser = Object.keys(USERS)[0] || '';
  return allExpenses.filter(e=>(e.user||firstUser)===user); 
}
function getMonthExp(user){
  const y=currentDate.getFullYear(),m=currentDate.getMonth();
  return getExpenses(user).filter(e=>e.date.startsWith(`${y}-${String(m+1).padStart(2,'0')}`));
}
function updateBadges(){
  Object.keys(USERS).forEach(u=>{
    const t=getMonthExp(u).reduce((s,e)=>s+e.amount,0);
    const pb=document.getElementById('pilBadge-'+u);
    if(pb) pb.textContent=t>=1000?(t/1000).toFixed(0)+'–∫':t.toFixed(0);
    const pa=document.getElementById('pilAmt-'+u);
    if(pa) pa.textContent=fmt(t);
    const sb=document.getElementById('sdBadge-'+u);
    if(sb) sb.textContent=fmt(t);
  });
  const sh=getMonthExp('shared').reduce((s,e)=>s+e.amount,0);
  const ps=document.getElementById('pilSum');
  if(ps) ps.textContent=fmt(sh);
  const sbs=document.getElementById('sdBadge-shared');
  if(sbs) sbs.textContent=fmt(sh);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  VIEW SWITCH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchView(v){
  currentView=v;
  ['calendar','charts','plan','settings'].forEach(id=>{
    document.getElementById('view'+id.charAt(0).toUpperCase()+id.slice(1))?.classList.toggle('active',id===v);
  });
  // Bottom nav
  document.querySelectorAll('.nav-item[data-view]').forEach(el=>el.classList.toggle('active',el.dataset.view===v));
  // Desktop sidebar
  document.querySelectorAll('.sd-item[data-view]').forEach(el=>el.classList.toggle('active',el.dataset.view===v));
  if(v==='charts')   renderCharts();
  if(v==='plan')     renderPlan();
  if(v==='settings') renderSettingsUI();
}

function renderAll(){
  updateBadges();
  updateSidebarUsers();
  renderCalendar();
  if(currentView==='charts')   renderCharts();
  if(currentView==='plan')     renderPlan();
  if(currentView==='settings') renderSettingsUI();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CALENDAR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getDayExp(y,m,d){
  const key=`${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
  return getExpenses(activeUser).filter(e=>{
    if(e.date!==key) return false;
    if(activeFilter&&e.category!==activeFilter) return false;
    return true;
  });
}

function renderCalendar(){
  const y=currentDate.getFullYear(),m=currentDate.getMonth();
  document.getElementById('calMonthLabel').textContent=`${getMonths()[m]} ${y}`;
  document.getElementById('planMonthLabel').textContent=`${getMonths()[m]} ${y}`;

  const container=document.getElementById('calContainer');
  container.innerHTML='';

  // Build grid
  const gridDiv=document.createElement('div'); gridDiv.className='cal-grid';
  getDays().forEach(d=>{const e=document.createElement('div');e.className='cal-dow';e.textContent=d;gridDiv.appendChild(e);});

  let first=new Date(y,m,1).getDay(); first=(first===0)?6:first-1;
  const dim=new Date(y,m+1,0).getDate(), prevD=new Date(y,m,0).getDate(), today=new Date();
  const cells=[];
  for(let i=first-1;i>=0;i--) cells.push({day:prevD-i,month:m-1,year:m===0?y-1:y,other:true});
  for(let d=1;d<=dim;d++) cells.push({day:d,month:m,year:y,other:false});
  const rem=(7-(cells.length%7))%7;
  for(let d=1;d<=rem;d++) cells.push({day:d,month:m+1,year:m===11?y+1:y,other:true});

  const weekTotals=[];
  for(let i=0;i<cells.length;i+=7){
    let wt=0;
    cells.slice(i,i+7).forEach(c=>{if(!c.other) wt+=getDayExp(c.year,c.month,c.day).reduce((s,e)=>s+e.amount,0);});
    weekTotals.push(wt);
  }
  const monthTotal=weekTotals.reduce((s,w)=>s+w,0);

  cells.forEach((c,idx)=>{
    const cell=document.createElement('div');
    cell.className='cal-cell'+(c.other?' other-month':'');
    const isT=!c.other&&c.day===today.getDate()&&c.month===today.getMonth()&&c.year===today.getFullYear();
    if(isT) cell.classList.add('today');
    const exps=c.other?[]:getDayExp(c.year,c.month,c.day);
    const total=exps.reduce((s,e)=>s+e.amount,0);

    const dEl=document.createElement('div'); dEl.className='cell-day'; dEl.textContent=c.day; cell.appendChild(dEl);

    if(exps.length>0&&!c.other){
      const dotsWrap=document.createElement('div'); dotsWrap.className='cell-exp-dot';
      exps.slice(0,5).forEach(exp=>{
        const cat=CATS[exp.category]||CATS['–ü—Ä–æ—á–µ–µ'];
        const dot=document.createElement('div'); dot.className='cell-dot'; dot.style.background=cat.color;
        dotsWrap.appendChild(dot);
      });
      cell.appendChild(dotsWrap);
      const tt=document.createElement('div'); tt.className='cell-total'; tt.textContent=Number(total).toLocaleString('ru-RU');
      cell.appendChild(tt);
    }

    cell.onclick=()=>{
      if(c.other) return;
      const dt=`${c.year}-${String(c.month+1).padStart(2,'0')}-${String(c.day).padStart(2,'0')}`;
      if(exps.length===0) openAddModal(dt);
      else if(exps.length===1) showDetail(exps[0]);
      else showDaySheet(exps, dt);
    };
    gridDiv.appendChild(cell);

    // Week total row after every 7 cells
    if((idx+1)%7===0 && idx<cells.length-1){
      const wIdx=Math.floor(idx/7);
      const wt=weekTotals[wIdx];
    }
  });
  container.appendChild(gridDiv);

  // Week total chips
  weekTotals.forEach((wt,i)=>{
    const row=document.createElement('div'); row.className='week-totals-row';
    row.innerHTML=`<span style="color:var(--text3);font-size:9px">–ù–µ–¥ ${i+1}</span><span class="wt-chip">${wt>0?Number(wt).toLocaleString('ru-RU'):'‚Äî'}</span>`;
    // insert after row i (7*(i+1) cells = row)
    // We'll do it differently ‚Äì just append all after grid
    container.appendChild(row);
  });

  // Month summary
  const ms=document.createElement('div'); ms.className='month-summary';
  ms.innerHTML=`<div><div class="ms-label">–ó–∞ –º–µ—Å—è—Ü</div><div class="ms-curr">${currency}</div></div><div class="ms-amount">${Number(monthTotal).toLocaleString('ru-RU')}</div>`;
  container.appendChild(ms);

  // Recent list
  renderRecentList();
  updateBadges();
}

function renderRecentList(){
  const el=document.getElementById('recentList');
  const exps=[...getMonthExp(activeUser)].sort((a,b)=>b.date.localeCompare(a.date)||((b.ts||0)-(a.ts||0))).slice(0,15);
  const now=Date.now();
  el.innerHTML=exps.map(exp=>{
    const cat=CATS[exp.category]||CATS['–ü—Ä–æ—á–µ–µ'];
    const uc=USERS[exp.user];
    const isNew=(now-(exp.ts||0))<90000; // 90 sec
    const dt=new Date(exp.date+'T12:00:00');
    const dateStr=`${dt.getDate()} ${getMonthsG()[dt.getMonth()]}`;
    const userChip=activeUser==='shared'?`<span class="exp-user-tag" style="background:${uc.color}">${uc.name}</span>`:'';
    const newBadge=isNew?'<span class="new-badge"></span>':'';
    return `<div class="expense-card" onclick="showDetailById('${exp.id}')">
      <div class="exp-icon" style="background:${cat.color}22">${cat.icon}</div>
      <div class="exp-info">
        <div class="exp-name">${exp.name}${newBadge}</div>
        <div class="exp-meta">${dateStr} ¬∑ ${exp.category}</div>
        ${userChip}
      </div>
      <div class="exp-right">
        <div class="exp-amt">${fmt(exp.amount)}</div>
      </div>
    </div>`;
  }).join('');
}

function prevMonth(){currentDate.setMonth(currentDate.getMonth()-1);renderCalendar();}
function nextMonth(){currentDate.setMonth(currentDate.getMonth()+1);renderCalendar();}
function goToToday(){currentDate=new Date();renderCalendar();}

// Day sheet (when multiple expenses on one day)
function showDaySheet(exps, dateStr){
  // Show as bottom sheet with list
  const existing=document.getElementById('daySheet');
  if(existing) existing.remove();
  const sheet=document.createElement('div');
  sheet.id='daySheet';
  sheet.className='bottom-sheet open';
  const dt=new Date(dateStr+'T12:00:00');
  sheet.innerHTML=`<div class="bs-overlay" onclick="document.getElementById('daySheet').remove()"></div>
  <div class="bs-content">
    <div class="bs-handle"></div>
    <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:16px;margin-bottom:14px">${dt.getDate()} ${getMonthsG()[dt.getMonth()]}</div>
    ${exps.map(exp=>{
      const cat=CATS[exp.category]||CATS['–ü—Ä–æ—á–µ–µ'];
      const uc=USERS[exp.user];
      return `<div class="expense-card" style="padding:10px 0;border-bottom:1px solid var(--border)" onclick="document.getElementById('daySheet').remove();showDetailById('${exp.id}')">
        <div class="exp-icon" style="background:${cat.color}22;width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:17px;flex-shrink:0;">${cat.icon}</div>
        <div class="exp-info"><div class="exp-name" style="font-size:13px">${exp.name}</div><div class="exp-meta">${exp.category}</div></div>
        <div class="exp-right"><div class="exp-amt" style="font-size:14px">${fmt(exp.amount)}</div><span style="font-size:9px;font-weight:700;padding:2px 6px;border-radius:5px;color:white;background:${uc.color}">${uc.name}</span></div>
      </div>`;
    }).join('')}
    <button class="btn btn-primary" style="margin-top:14px" onclick="document.getElementById('daySheet').remove();openAddModal('${dateStr}')">Ôºã –î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥</button>
  </div>`;
  document.body.appendChild(sheet);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ADD / EDIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openAddModal(dateStr){
  editingId=null;
  const userIds=Object.keys(USERS);
  document.getElementById('expUser').innerHTML=userIds.map(uid=>`<option value="${uid}">üë§ ${USERS[uid].name}</option>`).join('');
  // Default to active user if they are a real user (not 'shared'), else first user
  const defaultUser = (activeUser && USERS[activeUser]) ? activeUser : (userIds[0]||'');
  document.getElementById('expUser').value=defaultUser;
  document.getElementById('expName').value='';
  document.getElementById('expAmount').value='';
  document.getElementById('expDate').value=dateStr||new Date().toISOString().slice(0,10);
  document.getElementById('expCat').innerHTML=getCatOptions();
  document.getElementById('expNote').value='';
  document.getElementById('addTitle').innerHTML=`–î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥ <button class="modal-close" onclick="closeModal('addModal')">√ó</button>`;
  document.getElementById('addModal').classList.add('open');
}
function openEditModal(exp){
  editingId=exp.id;
  const userIds=Object.keys(USERS);
  document.getElementById('expUser').innerHTML=userIds.map(uid=>`<option value="${uid}">üë§ ${USERS[uid].name}</option>`).join('');
  document.getElementById('expUser').value=exp.user;
  document.getElementById('expName').value=exp.name;
  document.getElementById('expAmount').value=exp.amount;
  document.getElementById('expDate').value=exp.date;
  document.getElementById('expCat').innerHTML=getCatOptions();
  document.getElementById('expCat').value=exp.category;
  document.getElementById('expNote').value=exp.note||'';
  document.getElementById('addTitle').innerHTML=`–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å <button class="modal-close" onclick="closeModal('addModal')">√ó</button>`;
  document.getElementById('addModal').classList.add('open');
  closeDetail();
}
function saveExpense(){
  const user=document.getElementById('expUser').value;
  const name=document.getElementById('expName').value.trim();
  const amount=parseFloat(document.getElementById('expAmount').value);
  const date=document.getElementById('expDate').value;
  const category=document.getElementById('expCat').value;
  const note=document.getElementById('expNote').value.trim();
  if(!name||!amount||!date){showToast('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ, —Å—É–º–º—É –∏ –¥–∞—Ç—É');return;}
  if(editingId!==null){
    const i=allExpenses.findIndex(e=>e.id===editingId);
    if(i>=0) allExpenses[i]={...allExpenses[i],user,name,amount,date,category,note,ts:Date.now()};
  } else {
    allExpenses.push({id:Date.now()+Math.random(),user,name,amount,date,category,note,ts:Date.now()});
  }
  save(); closeModal('addModal'); renderCalendar();
  if(currentView==='charts') renderCharts();
  if(currentView==='plan')   renderPlan();
  showToast('‚úÖ –†–∞—Å—Ö–æ–¥ —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
}
function closeModal(id){ document.getElementById(id).classList.remove('open'); }
function getCatOptions(){ return Object.entries(CATS).map(([name,data])=>`<option value="${name}">${data.icon} ${name}</option>`).join(''); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DETAIL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showDetailById(id){
  const exp=allExpenses.find(e=>String(e.id)===String(id));
  if(exp) showDetail(exp);
}
function showDetail(exp){
  detailId=exp.id;
  const cat=CATS[exp.category]||CATS['–ü—Ä–æ—á–µ–µ'],uc=USERS[exp.user];
  document.getElementById('dName').textContent=exp.name;
  document.getElementById('dCat').textContent=`${cat.icon} ${exp.category}`;
  document.getElementById('dCat').style.color=cat.color;
  document.getElementById('dAmt').textContent=fmt(exp.amount);
  const dt=new Date(exp.date+'T12:00:00');
  document.getElementById('dDate').textContent=`${dt.getDate()} ${getMonthsG()[dt.getMonth()]} ${dt.getFullYear()}`;
  document.getElementById('dNote').textContent=exp.note?`üìù ${exp.note}`:'';
  document.getElementById('dUser').textContent=uc.name;
  document.getElementById('dUser').style.background=uc.color;
  document.getElementById('expDet').classList.add('open');
}
function closeDetail(){ document.getElementById('expDet').classList.remove('open'); detailId=null; }
function editFromDetail(){ const e=allExpenses.find(x=>x.id===detailId); if(e)openEditModal(e); }
function deleteFromDetail(){
  if(!detailId||!confirm('–£–¥–∞–ª–∏—Ç—å —Ä–∞—Å—Ö–æ–¥?')) return;
  allExpenses=allExpenses.filter(e=>e.id!==detailId);
  save(); closeDetail(); renderCalendar();
  if(currentView==='charts') renderCharts();
  if(currentView==='plan')   renderPlan();
  showToast('üóë –£–¥–∞–ª–µ–Ω–æ');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CHARTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderCharts(){
  const exps=getMonthExp(activeUser),total=exps.reduce((s,e)=>s+e.amount,0);
  const prevM=new Date(currentDate.getFullYear(),currentDate.getMonth()-1,1);
  const prevPfx=`${prevM.getFullYear()}-${String(prevM.getMonth()+1).padStart(2,'0')}`;
  const prevTotal=getExpenses(activeUser).filter(e=>e.date.startsWith(prevPfx)).reduce((s,e)=>s+e.amount,0);
  const change=prevTotal?((total-prevTotal)/prevTotal*100).toFixed(0):0;
  const topCat=Object.keys(CATS).reduce((a,c)=>{const s=exps.filter(e=>e.category===c).reduce((x,e)=>x+e.amount,0);return s>(a.sum||0)?{cat:c,sum:s}:a;},{});
  const bTotal=Object.values(budgets).reduce((s,b)=>s+b,0);
  document.getElementById('statsGrid').innerHTML=`
    <div class="stat-card"><div class="stat-label">–ü–æ—Ç—Ä–∞—á–µ–Ω–æ</div><div class="stat-value" style="font-size:16px">${fmt(total)}</div><div class="stat-sub ${change>0?'up':'down'}">${change>0?'‚Üë':'‚Üì'} ${Math.abs(change)}%</div></div>
    <div class="stat-card"><div class="stat-label">–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</div><div class="stat-value">${exps.length}</div><div class="stat-sub">–∑–∞ –º–µ—Å—è—Ü</div></div>
    <div class="stat-card"><div class="stat-label">–¢–æ–ø</div><div class="stat-value" style="font-size:15px">${topCat.cat?CATS[topCat.cat].icon+' '+topCat.cat:'‚Äî'}</div><div class="stat-sub">${topCat.sum?Number(topCat.sum).toLocaleString('ru-RU'):'‚Äî'}</div></div>
    <div class="stat-card"><div class="stat-label">–û—Å—Ç–∞—Ç–æ–∫</div><div class="stat-value" style="font-size:16px;color:var(--green)">${fmt(Math.max(0,bTotal-total))}</div><div class="stat-sub">–∏–∑ ${fmt(bTotal)}</div></div>`;

  const cs=document.getElementById('compareSection');
  if(activeUser==='shared'){
    const userIds=Object.keys(USERS);
    const u1id=userIds[0]||'', u2id=userIds[1]||'';
    const u1E=getMonthExp(u1id),u2E=getMonthExp(u2id);
    const bT=u1E.reduce((s,e)=>s+e.amount,0),vT=u2E.reduce((s,e)=>s+e.amount,0);
    const comb=bT+vT||1,bP=(bT/comb*100).toFixed(0),vP=(vT/comb*100).toFixed(0);
    const u1name=USERS[u1id]?.name||u1id, u2name=USERS[u2id]?.name||u2id;
    cs.innerHTML=`<div class="compare-row"><div class="compare-card"><div class="compare-head"><div class="compare-dot" style="background:var(--u1)"></div><div class="compare-name" style="color:var(--u1)">${u1name}</div></div><div class="compare-total">${fmt(bT)}</div><div class="compare-sub">${u1E.length} —Ç—Ä ¬∑ ${bP}%</div></div><div class="compare-card"><div class="compare-head"><div class="compare-dot" style="background:var(--u2)"></div><div class="compare-name" style="color:var(--u2)">${u2name}</div></div><div class="compare-total">${fmt(vT)}</div><div class="compare-sub">${u2E.length} —Ç—Ä ¬∑ ${vP}%</div></div></div><div class="versus-bar"><div class="versus-fill1" style="width:${bP}%"></div><div class="versus-fill2" style="width:${vP}%"></div></div><div class="versus-labels"><span style="color:var(--u1)">${u1name} ${bP}%</span><span style="color:var(--u2)">${u2name} ${vP}%</span></div>`;
  } else cs.innerHTML='';

  const catT={};Object.keys(CATS).forEach(c=>catT[c]=0);
  exps.forEach(e=>{if(catT[e.category]!==undefined) catT[e.category]+=e.amount;});
  const maxV=Math.max(...Object.values(catT),1);
  document.getElementById('barChart').innerHTML=Object.entries(catT).filter(([,v])=>v>0).sort((a,b)=>b[1]-a[1]).map(([cat,val])=>
    `<div class="bar-item"><div class="bar-label">${CATS[cat].icon} ${cat}</div><div class="bar-track"><div class="bar-fill" style="width:${(val/maxV*100).toFixed(1)}%;background:${CATS[cat].color}"></div></div><div class="bar-amount">${Number(val).toLocaleString('ru-RU')}</div></div>`).join('');

  const dData=Object.entries(catT).filter(([,v])=>v>0).sort((a,b)=>b[1]-a[1]);
  const cx=60,cy=60,r=52,ir=32; let ang=-Math.PI/2; const svgP=[];
  dData.forEach(([cat,val])=>{
    if(!total) return;
    const sw=(val/total)*2*Math.PI,x1=cx+r*Math.cos(ang),y1=cy+r*Math.sin(ang),x2=cx+r*Math.cos(ang+sw),y2=cy+r*Math.sin(ang+sw);
    const ix1=cx+ir*Math.cos(ang),iy1=cy+ir*Math.sin(ang),ix2=cx+ir*Math.cos(ang+sw),iy2=cy+ir*Math.sin(ang+sw);
    const lg=sw>Math.PI?1:0;
    svgP.push(`<path d="M${x1},${y1} A${r},${r} 0 ${lg},1 ${x2},${y2} L${ix2},${iy2} A${ir},${ir} 0 ${lg},0 ${ix1},${iy1} Z" fill="${CATS[cat].color}" opacity="0.9"/>`);
    ang+=sw;
  });
  svgP.push(`<text x="${cx}" y="${cy+4}" text-anchor="middle" fill="var(--amount-color)" font-size="10" font-family="Syne" font-weight="700">${total>=1000?(total/1000).toFixed(0)+'–∫':total}</text>`);
  document.getElementById('donutSvg').innerHTML=svgP.join('');
  document.getElementById('donutLegend').innerHTML=dData.map(([cat,val])=>`<div class="legend-item"><div class="legend-dot" style="background:${CATS[cat].color}"></div><span class="legend-name">${cat}</span><span class="legend-pct">${total>0?(val/total*100).toFixed(0):0}%</span></div>`).join('');

  const months=[];
  for(let i=5;i>=0;i--){const d2=new Date(currentDate.getFullYear(),currentDate.getMonth()-i,1);const pfx=`${d2.getFullYear()}-${String(d2.getMonth()+1).padStart(2,'0')}`;const tot=getExpenses(activeUser).filter(e=>e.date.startsWith(pfx)).reduce((s,e)=>s+e.amount,0);months.push({label:getMonths()[d2.getMonth()].slice(0,3),total:tot});}
  const maxT=Math.max(...months.map(m=>m.total),100);
  const svg=document.getElementById('trendSvg'),W=svg.clientWidth||320,H=140;
  const pts=months.map((m,i)=>[20+(i/(months.length-1))*(W-40),15+((1-m.total/maxT)*(H-30)),m]);
  const pathD=pts.map((p,i)=>`${i===0?'M':'L'}${p[0]},${p[1]}`).join(' ');
  svg.innerHTML=`<defs><linearGradient id="tg" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="var(--accent)" stop-opacity="0.35"/><stop offset="100%" stop-color="var(--accent)" stop-opacity="0"/></linearGradient></defs><path d="${pathD} L${pts[pts.length-1][0]},${H} L${pts[0][0]},${H} Z" fill="url(#tg)"/><path d="${pathD}" fill="none" stroke="var(--accent)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>${pts.map(p=>`<circle cx="${p[0]}" cy="${p[1]}" r="4" fill="var(--accent)"/><text x="${p[0]}" y="${H+16}" text-anchor="middle" fill="var(--text3)" font-size="10" font-family="DM Sans">${p[2].label}</text><text x="${p[0]}" y="${p[1]-8}" text-anchor="middle" fill="var(--amount-color)" font-size="10" font-family="DM Sans" font-weight="600">${p[2].total>0?Number(p[2].total).toLocaleString('ru-RU'):''}</text>`).join('')}`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PLAN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderPlan(){
  document.getElementById('planMonthLabel').textContent=`${getMonths()[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
  const exps=getMonthExp(activeUser),catT={};
  Object.keys(CATS).forEach(c=>catT[c]=0);
  exps.forEach(e=>{if(catT[e.category]!==undefined) catT[e.category]+=e.amount;});
  const planHtml=Object.keys(CATS).map(cat=>{
    const sp=catT[cat],bud=budgets[cat]||0,pct=bud?Math.min(sp/bud*100,100):0,over=sp>bud&&bud>0;
    return `<div class="plan-card">
      <div class="plan-card-header"><div class="plan-cat"><div class="plan-cat-dot" style="background:${CATS[cat].color}"></div>${CATS[cat].icon} ${cat}</div><span onclick="openPlanModal()" style="font-size:11px;color:var(--accent);cursor:pointer">‚úèÔ∏è</span></div>
      <div class="plan-amounts"><span><span class="av">${Number(sp).toLocaleString('ru-RU')}</span> –ø–æ—Ç—Ä–∞—á–µ–Ω–æ</span><span><span class="av">${Number(bud).toLocaleString('ru-RU')}</span> –ª–∏–º–∏—Ç</span></div>
      <div class="plan-bar-track"><div class="plan-bar-fill" style="width:${pct}%;background:${over?'var(--red)':CATS[cat].color}"></div></div>
      <div class="plan-pct">${bud?`${pct.toFixed(0)}%${over?' ‚Äî –ø—Ä–µ–≤—ã—à–µ–Ω!':''}`:'–õ–∏–º–∏—Ç –Ω–µ –∑–∞–¥–∞–Ω'}</div>
    </div>`;
  }).join('');
  document.getElementById('planGrid').innerHTML=planHtml;
}
function openPlanModal(){
  document.getElementById('budgetFields').innerHTML=Object.keys(CATS).map(cat=>`<div class="form-group"><label class="form-label">${CATS[cat].icon} ${cat}</label><input class="form-input" id="bud_${cat}" type="number" value="${budgets[cat]||''}" placeholder="0" min="0" inputmode="decimal"/></div>`).join('');
  document.getElementById('planModal').classList.add('open');
}
function saveBudgets(){
  Object.keys(CATS).forEach(cat=>{const v=parseFloat(document.getElementById('bud_'+cat)?.value||0);budgets[cat]=v||0;});
  saveBud(); closeModal('planModal');
  if(currentView==='plan')   renderPlan();
  if(currentView==='charts') renderCharts();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SETTINGS UI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  I18N APPLY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function applyLang(newLang, save_){
  const prevLang = lang;
  lang = newLang;
  const tr = I18N[lang];

  // Translate built-in category names in CATS
  // Build reverse map: any localized name -> canonical RU key
  const reverseMap = {};
  Object.keys(I18N).forEach(l=>{
    if(I18N[l].cats) Object.entries(I18N[l].cats).forEach(([ruKey,locName])=>{ reverseMap[locName]=ruKey; });
  });
  // Also map RU keys to themselves
  Object.keys(DEFAULT_CATS).forEach(k=>{ reverseMap[k]=k; });

  if(tr.cats){
    const newCats = {};
    Object.entries(CATS).forEach(([name, data])=>{
      const ruKey = reverseMap[name] || name; // find original RU key
      const newName = (data.builtin && tr.cats[ruKey]) ? tr.cats[ruKey] : name;
      // Also update expenses
      if(newName !== name){
        allExpenses.forEach(e=>{ if(e.category===name) e.category=newName; });
      }
      newCats[newName] = {...data};
    });
    Object.keys(CATS).forEach(k=>delete CATS[k]);
    Object.assign(CATS, newCats);
    // Update catOrder in cfg
    if(cfg.catOrder) cfg.catOrder = cfg.catOrder.map(n=>{ const ruKey=reverseMap[n]||n; return (tr.cats[ruKey])||n; });
  } // end if tr.cats

  // Update nav labels
  const navItems = document.querySelectorAll('.nav-item .nav-label');
  const navKeys = ['calendar','analytics','plan','settings'];
  navItems.forEach((el,i)=>{ if(navKeys[i]) el.textContent=t(navKeys[i]); });
  // Update sidebar nav
  document.querySelectorAll('.sd-nav-item').forEach(el=>{
    const view = el.dataset.view;
    if(view && t(view)!==view) el.querySelector('.sd-nav-label') && (el.querySelector('.sd-nav-label').textContent=t(view));
  });

  // Update MONTHS/DAYS globals used in calendar
  window._MONTHS   = tr.months;
  window._MONTHS_G = tr.months_g;
  window._DAYS     = tr.days;

  if(save_){
    cfg.lang = lang;
    saveCfg();
    if(allExpenses.length) save(); // save translated expenses
  }

  // Update all data-i18n elements
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const key = el.getAttribute('data-i18n');
    el.textContent = t(key);
  });

  buildSidebarCats();
  renderCalendar();
  if(currentView==='settings') renderSettingsUI();
  if(currentView==='charts')   renderCharts();
  if(currentView==='plan')     renderPlan();
  updateBadges();
}

function saveLangSetting(){
  const sel = document.getElementById('settingLang');
  if(!sel) return;
  applyLang(sel.value, true);
  showToast(t('saved'));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CATEGORY ORDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function moveCat(name, dir){
  const keys = Object.keys(CATS);
  const idx = keys.indexOf(name);
  const newIdx = idx + dir;
  if(newIdx < 0 || newIdx >= keys.length) return;
  // Swap
  const tmp = keys[idx]; keys[idx]=keys[newIdx]; keys[newIdx]=tmp;
  const newCats = {};
  keys.forEach(k=>{ newCats[k]=CATS[k]; });
  Object.keys(CATS).forEach(k=>delete CATS[k]);
  Object.assign(CATS, newCats);
  cfg.catOrder = keys;
  saveCfg();
  buildSidebarCats();
  renderCatManageList();
  renderCatColorList();
}

function renderSettingsUI(){
  const el=document.getElementById('amtPicker');
  if(el){ el.value=amountColor; document.getElementById('amtHex').value=amountColor; updateAmtPreview(amountColor); }
  const cs=document.getElementById('settingCurrency');
  if(cs) cs.value=currency;
  const ls=document.getElementById('settingLang');
  if(ls) ls.value=lang;
  renderCatManageList();
  renderCatColorList();
  renderUserSettings();
  buildSidebarCats();
  // Restore firebase UI ‚Äî always show current URL
  const shownUrl  = cfg.fbUrl  || DEFAULT_FB_URL;
  const shownRoom = cfg.fbRoom || DEFAULT_FB_ROOM;
  document.getElementById('fbUrl').value  = shownUrl;
  document.getElementById('fbRoom').value = shownRoom;
  // Update translatable UI elements
  const _ti = (id, key) => { const e=document.getElementById(id); if(e) e.textContent=t(key); };
  _ti('s_lang_h', 's_lang'); _ti('s_lang_btn','save'); _ti('s_data_h','s_data');
  // Nav labels
  const navLabels = document.querySelectorAll('.nav-label');
  const navViews  = ['calendar','analytics','plan','settings'];
  navLabels.forEach((el,i)=>{ if(navViews[i]) el.textContent=t(navViews[i]); });

  if(fbConnected){
    document.getElementById('fbStatus').className='firebase-status connected';
    document.getElementById('fbStatus').innerHTML='<span>‚óè</span>&nbsp;–ü–æ–¥–∫–ª—é—á–µ–Ω–æ ¬∑ ' + shownRoom;
    document.getElementById('btnDisconnect').style.display='block';
  }
}

function renderUserSettings(){
  const el=document.getElementById('userSettingsList');
  if(!el) return;
  el.innerHTML=Object.entries(USERS).map(([uid,u])=>`
    <div style="background:var(--surface2);border-radius:12px;border:1px solid var(--border);padding:14px;margin-bottom:10px">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
        <div style="width:32px;height:32px;border-radius:9px;background:${u.color};display:flex;align-items:center;justify-content:center;font-family:'Syne',sans-serif;font-weight:800;font-size:14px;color:white" id="uAv-${uid}">${u.name[0]}</div>
        <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:14px;color:${u.color}" id="uLabel-${uid}">${u.name}</div>
      </div>
      <div class="form-group"><label class="form-label">–ò–º—è</label><input class="form-input" id="uname_${uid}" value="${u.name}" placeholder="–ò–º—è" oninput="previewUserCard('${uid}')"></div>
      <div class="form-group" style="margin-bottom:8px"><label class="form-label">–¶–≤–µ—Ç</label>
        <div style="display:flex;gap:8px;align-items:center">
          <input type="color" class="cp2" id="ucolor_${uid}" value="${u.color}" oninput="previewUserCard('${uid}')" style="width:46px;height:46px;border-radius:10px;">
          <div style="display:flex;flex-wrap:wrap;gap:5px;flex:1">${PALETTE_COLORS.slice(0,10).map(c=>`<div style="width:26px;height:26px;background:${c};border-radius:6px;cursor:pointer;border:2px solid transparent" onclick="quickSetUserColor('${uid}','${c}')"></div>`).join('')}</div>
        </div>
      </div>
      <button class="btn btn-primary" style="font-size:13px;padding:11px" onclick="saveUserSettings('${uid}')">‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>`).join('');
}
function previewUserCard(uid){
  const nameEl=document.getElementById('uname_'+uid), colorEl=document.getElementById('ucolor_'+uid);
  if(!nameEl||!colorEl) return;
  const name=nameEl.value.trim()||USERS[uid].name, color=colorEl.value;
  const av=document.getElementById('uAv-'+uid), lb=document.getElementById('uLabel-'+uid);
  if(av){av.style.background=color;av.textContent=name[0]||'?';}
  if(lb){lb.style.color=color;lb.textContent=name;}
}
function quickSetUserColor(uid,color){ const el=document.getElementById('ucolor_'+uid); if(el){el.value=color;previewUserCard(uid);} }
function saveUserSettings(uid){
  const name=document.getElementById('uname_'+uid)?.value.trim();
  const color=document.getElementById('ucolor_'+uid)?.value;
  if(!name){showToast('‚ùå –ò–º—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');return;}
  USERS[uid].name=name; USERS[uid].color=color;
  if(!cfg.users) cfg.users={};
  cfg.users[uid]={name,color};
  saveCfg();
  const userIds=Object.keys(USERS);
  if(userIds[0]) document.documentElement.style.setProperty('--u1',USERS[userIds[0]].color);
  if(userIds[1]) document.documentElement.style.setProperty('--u2',USERS[userIds[1]].color);
  updateSidebarUsers();
  renderCalendar();
  if(currentView==='charts') renderCharts();
  renderUserSettings();
  showToast(`‚úÖ ¬´${name}¬ª –æ–±–Ω–æ–≤–ª—ë–Ω`);
}
function updateSidebarUsers(){
  Object.keys(USERS).forEach(uid=>{
    const u=USERS[uid];
    const pa=document.getElementById('pilAv-'+uid); if(pa){pa.style.background=u.color;pa.textContent=u.name[0];}
    const pn=document.getElementById('pilName-'+uid); if(pn) pn.textContent=u.name;
    const pb=document.getElementById('pilBadge-'+uid); if(pb) pb.style.background=u.color;
    const sa=document.getElementById('sdAv-'+uid); if(sa){sa.style.background=u.color;sa.textContent=u.name[0];}
    const sn=document.getElementById('sdName-'+uid); if(sn) sn.textContent=u.name;
  });
}

function renderCatManageList(){
  const el=document.getElementById('catManageList'); if(!el) return;
  const keys = Object.keys(CATS);
  el.innerHTML=keys.map((name,i)=>{
    const data=CATS[name];
    return `<div class="cat-manage-row">
      <div style="display:flex;flex-direction:column;gap:2px;margin-right:2px">
        <button onclick="moveCat('${name}',-1)" ${i===0?'disabled':''} style="background:none;border:none;color:${i===0?'var(--text3)':'var(--text2)'};cursor:${i===0?'default':'pointer'};font-size:13px;padding:0;line-height:1;">‚Üë</button>
        <button onclick="moveCat('${name}',1)" ${i===keys.length-1?'disabled':''} style="background:none;border:none;color:${i===keys.length-1?'var(--text3)':'var(--text2)'};cursor:${i===keys.length-1?'default':'pointer'};font-size:13px;padding:0;line-height:1;">‚Üì</button>
      </div>
      <span style="font-size:18px">${data.icon}</span>
      <div style="width:12px;height:12px;border-radius:50%;background:${data.color};flex-shrink:0"></div>
      <span class="cat-manage-name">${name}</span>
      <button onclick="openEditCat('${name}')" style="background:var(--surface3);border:1px solid var(--border);color:var(--text2);border-radius:7px;padding:5px 10px;font-size:12px;cursor:pointer;">‚úèÔ∏è</button>
      <button class="cat-manage-del" onclick="deleteCat('${name}')">üóë</button>
    </div>`;
  }).join('');
}
function renderCatColorList(){
  const el=document.getElementById('catColorList'); if(!el) return;
  el.innerHTML=Object.keys(CATS).map(cat=>`
    <div class="color-row">
      <div class="crLeft"><div class="cr-dot" id="crdot-${cat}" style="background:${CATS[cat].color}"></div><span style="font-size:13px;font-weight:500;color:var(--text)">${CATS[cat].icon} ${cat}</span></div>
      <div class="crRight">
        <input type="color" class="cp2" id="crpick-${cat}" value="${CATS[cat].color}" oninput="applyCatColor('${cat}',this.value)">
        ${CATS[cat].builtin?`<button class="creset" onclick="resetCatColor('${cat}')">‚Ü∫</button>`:''}
      </div>
    </div>`).join('');
}
function updateAmtPreview(c){ const e=document.getElementById('pvAmt'); if(e){ e.style.color=c; e.textContent='28 450 '+(currency||'‚Ç¨'); } }
function syncAmtPicker(v){ document.getElementById('amtHex').value=v; updateAmtPreview(v); }
function syncAmtHex(v){ if(/^#[0-9a-fA-F]{6}$/.test(v)){document.getElementById('amtPicker').value=v;updateAmtPreview(v);} }
function setAmtColor(c){ document.getElementById('amtPicker').value=c; document.getElementById('amtHex').value=c; updateAmtPreview(c); }
function saveAmtColor(){ amountColor=document.getElementById('amtPicker').value; cfg.amountColor=amountColor; saveCfg(); document.documentElement.style.setProperty('--amount-color',amountColor); showToast('‚úÖ –¶–≤–µ—Ç –æ–±–Ω–æ–≤–ª—ë–Ω'); }
function applyCatColor(cat,color){ CATS[cat].color=color; const d=document.getElementById('crdot-'+cat); if(d)d.style.background=color; if(!cfg.catColors)cfg.catColors={}; cfg.catColors[cat]=color; saveCfg(); renderCalendar(); }
function resetCatColor(cat){ const def=DEFAULT_CATS[cat]?.color; if(!def)return; CATS[cat].color=def; const p=document.getElementById('crpick-'+cat),d=document.getElementById('crdot-'+cat); if(p)p.value=def; if(d)d.style.background=def; if(!cfg.catColors)cfg.catColors={}; cfg.catColors[cat]=def; saveCfg(); renderCalendar(); }
function resetAllCats(){ Object.keys(DEFAULT_CATS).forEach(c=>{CATS[c].color=DEFAULT_CATS[c].color;}); cfg.catColors={}; Object.keys(DEFAULT_CATS).forEach(c=>cfg.catColors[c]=DEFAULT_CATS[c].color); saveCfg(); renderSettingsUI(); renderCalendar(); }
function saveCurrencySetting(){ currency=document.getElementById('settingCurrency').value; cfg.currency=currency; saveCfg(); renderCalendar(); if(currentView==='charts')renderCharts(); if(currentView==='plan')renderPlan(); updateAmtPreview(document.getElementById('amtPicker')?.value||amountColor); showToast('‚úÖ –í–∞–ª—é—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞'); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CUSTOM CATS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildSidebarCats(){
  const el=document.getElementById('sdCatList'); if(!el) return;
  el.innerHTML=Object.entries(CATS).map(([name,data])=>
    `<div class="sd-item" onclick="filterCat('${name}')"><span class="sd-icon">${data.icon}</span>${name}</div>`).join('');
}
function filterCat(cat){ activeFilter=cat; renderCalendar(); }
function toggleEmojiPicker(ev){
  ev.stopPropagation();
  const ep=document.getElementById('emojiPicker');
  const btn=document.getElementById('emojiPickerBtn');
  const rect=btn.getBoundingClientRect();
  ep.style.top=(rect.bottom+6)+'px';
  ep.style.left=Math.min(rect.left,window.innerWidth-290)+'px';
  ep.classList.toggle('open');
}
function initEmojiPicker(){
  const ep=document.getElementById('emojiPicker');
  ep.innerHTML=EMOJI_LIST.map(e=>`<button class="ep-emoji" onclick="selectEmoji('${e}')">${e}</button>`).join('');
  const ep2=document.getElementById('editCatEmojiPicker');
  if(ep2) ep2.innerHTML=EMOJI_LIST.map(e=>`<button class="ep-emoji" onclick="selectEditCatEmoji('${e}')">${e}</button>`).join('');
}
function selectEmoji(e){ selectedNewCatEmoji=e; document.getElementById('selectedEmoji').textContent=e; document.getElementById('emojiPicker').classList.remove('open'); }
function initColorPalette(){
  const pal=document.getElementById('newCatColorPalette');
  pal.innerHTML=PALETTE_COLORS.map(c=>`<div class="cp-swatch" style="background:${c}" onclick="selectNewCatColor('${c}',this)" title="${c}"></div>`).join('');
}
function selectNewCatColor(color,el){ document.getElementById('newCatColor').value=color; document.querySelectorAll('.cp-swatch').forEach(s=>s.classList.remove('selected')); el.classList.add('selected'); }
function addCustomCat(){
  const name=document.getElementById('newCatName').value.trim();
  if(!name){showToast('‚ùå –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');return;}
  if(CATS[name]){showToast('‚ùå –£–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');return;}
  const color=document.getElementById('newCatColor').value;
  CATS[name]={icon:selectedNewCatEmoji,color,builtin:false};
  if(!cfg.customCats)cfg.customCats={};
  cfg.customCats[name]={icon:selectedNewCatEmoji,color};
  saveCfg();
  document.getElementById('newCatName').value='';
  selectedNewCatEmoji='üè∑'; document.getElementById('selectedEmoji').textContent='üè∑';
  buildSidebarCats(); renderCatManageList(); renderCatColorList();
  showToast(`‚úÖ –ö–∞—Ç–µ–≥–æ—Ä–∏—è ¬´${name}¬ª –¥–æ–±–∞–≤–ª–µ–Ω–∞`);
}
function deleteCat(name){
  if(!confirm(`–£–¥–∞–ª–∏—Ç—å ¬´${name}¬ª?`)) return;
  delete CATS[name];
  if(cfg.customCats) delete cfg.customCats[name];
  if(cfg.catColors)  delete cfg.catColors[name];
  saveCfg(); buildSidebarCats(); renderCatManageList(); renderCatColorList();
  showToast(`üóë ¬´${name}¬ª —É–¥–∞–ª–µ–Ω–∞`);
}

let _editingCatName = null;
function openEditCat(name){
  const cat = CATS[name]; if(!cat) return;
  _editingCatName = name;
  document.getElementById('editCatOldName').value = name;
  document.getElementById('editCatName').value = name;
  document.getElementById('editCatName').disabled = false;
  document.getElementById('editCatColor').value = cat.color || '#6c8dfa';
  document.getElementById('editCatEmoji').textContent = cat.icon || 'üè∑';
  document.getElementById('selectedEditEmoji').value = cat.icon || 'üè∑';
  // Build emoji picker for edit modal
  const ep = document.getElementById('editEmojiPicker');
  if(ep) ep.innerHTML = EMOJI_LIST.map(e=>`<button class="ep-emoji" onclick="selectEditEmoji('${e}')">${e}</button>`).join('');
  document.getElementById('editCatModal').classList.add('open');
}
function selectEditEmoji(e){
  document.getElementById('editCatEmoji').textContent = e;
  document.getElementById('selectedEditEmoji').value = e;
  document.getElementById('editEmojiPicker').classList.remove('open');
}
function toggleEditEmojiPicker(ev){
  ev.stopPropagation();
  document.getElementById('editEmojiPicker').classList.toggle('open');
}
function saveEditCat(){
  const oldName = _editingCatName;
  const cat = CATS[oldName]; if(!cat) return;
  const newName  = document.getElementById('editCatName').value.trim();
  const newColor = document.getElementById('editCatColor').value;
  const newIcon  = document.getElementById('selectedEditEmoji').value || cat.icon;
  if(!newName){ showToast('‚ùå –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ'); return; }
  if(newName !== oldName && CATS[newName]){ showToast('‚ùå –¢–∞–∫–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è —É–∂–µ –µ—Å—Ç—å'); return; }

  // Update CATS
  const updated = {...cat, icon: newIcon, color: newColor};
  if(newName !== oldName){
    delete CATS[oldName];
    // Move expenses to new name
    allExpenses.forEach(e=>{ if(e.category===oldName) e.category=newName; });
    save();
  }
  CATS[newName] = updated;

  // Update cfg ‚Äî works for both builtin and custom
  if(!cfg.customCats) cfg.customCats = {};
  delete cfg.customCats[oldName];
  cfg.customCats[newName] = {icon:newIcon, color:newColor};
  if(!cfg.catColors) cfg.catColors={};
  if(oldName !== newName) delete cfg.catColors[oldName];
  cfg.catColors[newName] = newColor;

  saveCfg();
  buildSidebarCats(); renderCatManageList(); renderCatColorList(); renderCalendar();
  document.getElementById('editCatModal').classList.remove('open');
  showToast(`‚úÖ –ö–∞—Ç–µ–≥–æ—Ä–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  EXCEL EXPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportExcel(){
  try{
    const wb=XLSX.utils.book_new();
    const makeSheet=(user)=>{
      const data=user==='shared'?allExpenses:allExpenses.filter(e=>e.user===user);
      const headers=['–î–∞—Ç–∞','–ù–∞–∑–≤–∞–Ω–∏–µ','–ö–∞—Ç–µ–≥–æ—Ä–∏—è','–°—É–º–º–∞ ('+currency+')','–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å','–ó–∞–º–µ—Ç–∫–∞'];
      const rows=[headers];
      [...data].sort((a,b)=>a.date.localeCompare(b.date)).forEach(e=>rows.push([e.date,e.name,e.category,e.amount,USERS[e.user]?.name||e.user,e.note||'']));
      rows.push([]); rows.push(['–ò–¢–û–ì–û','','',data.reduce((s,e)=>s+e.amount,0),'','']);
      return XLSX.utils.aoa_to_sheet(rows);
    };
    Object.keys(USERS).forEach(uid=>{
      XLSX.utils.book_append_sheet(wb,makeSheet(uid),USERS[uid].name);
    });
    XLSX.utils.book_append_sheet(wb,makeSheet('shared'),'–í—Å–µ —Ä–∞—Å—Ö–æ–¥—ã');
    const now=new Date();
    XLSX.writeFile(wb,`FinFlow_${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}.xlsx`);
    showToast('üìä Excel —Å–∫–∞—á–∞–Ω!');
  }catch(e){alert('–û—à–∏–±–∫–∞: '+e.message);}
}
function exportJSON(){
  const blob=new Blob([JSON.stringify({allExpenses,budgets,cfg},null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);
  a.download=`finflow-${new Date().toISOString().slice(0,10)}.json`;a.click();
  showToast('üìã JSON —Å–∫–∞—á–∞–Ω!');
}
function clearAll(){
  if(!confirm('–£–¥–∞–ª–∏—Ç—å –í–°–ï —Ä–∞—Å—Ö–æ–¥—ã?')) return;
  allExpenses=[]; save(); renderCalendar();
  if(currentView==='charts') renderCharts();
  if(currentView==='plan')   renderPlan();
  showToast('üóë –î–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CLICK OUTSIDE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('click',e=>{
  const ep=document.getElementById('emojiPicker');
  const btn=document.getElementById('emojiPickerBtn');
  if(ep&&ep.classList.contains('open')&&!ep.contains(e.target)&&(!btn||!btn.contains(e.target))) ep.classList.remove('open');
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INIT ‚Äî wrapped in try/catch for iOS safety
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MULTI-ACCOUNT AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Accounts loaded from Firebase meta on startup.
// Login flow: Step1(pick account) ‚Üí Step2(pick user) ‚Üí Step3(enter password)

let _allAccounts  = {};   // loaded from Firebase
let _pendingAcc   = null; // { accId, accData }
let _pendingUser  = null; // { userId, userData }

const APP_VER = 'pro1';

// ‚îÄ‚îÄ Load accounts from Firebase ‚îÄ‚îÄ
// Always uses a single dedicated app instance for meta reads
let _metaApp = null;

function _getMetaApp(){
  // Try to reuse existing app
  try{ return firebase.app('ff_meta'); }catch(e){}
  // Create fresh
  try{ return firebase.initializeApp(Object.assign({}, FB_CONFIG), 'ff_meta'); }catch(e){}
  // Fallback to default
  try{ return firebase.app(); }catch(e){}
  return null;
}

function loadAccounts(cb){
  if(!window.firebase){ showAccountsError('Firebase SDK –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω'); return; }

  _metaApp = _getMetaApp();
  if(!_metaApp){ showAccountsError('–û—à–∏–±–∫–∞ Firebase SDK'); return; }

  const doRead = () => {
    _metaApp.database().ref(META_REF).once('value').then(snap=>{
      _allAccounts = {};
      const data = snap.val() || {};
      Object.entries(data).forEach(([accId, accData])=>{
        if(accId === '_system') return;
        _allAccounts[accId] = {
          name:  accData.name  || accId,
          color: accData.color || '#6c8dfa',
          users: accData.users || {},
        };
      });
      if(cb) cb();
    }).catch(err=>{ showAccountsError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + err.message); });
  };

  // Try anonymous auth first; if it fails or SDK missing ‚Äî read anyway (open rules fallback)
  try{
    const auth = _metaApp.auth();
    if(auth.currentUser){
      doRead();
      return;
    }
    // Wait for auth state ‚Äî more reliable than .then() on signInAnonymously
    let authDone = false;
    const unsub = auth.onAuthStateChanged(user=>{
      if(authDone) return;
      authDone = true;
      unsub();
      doRead();
    });
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
      .then(()=> auth.signInAnonymously())
      .catch(e=>{
        console.warn('Anonymous auth failed:', e.message);
        if(!authDone){ authDone=true; try{unsub();}catch(e2){} doRead(); }
      });
    // Safety timeout ‚Äî if auth hangs for 5s, read anyway
    setTimeout(()=>{
      if(!authDone){ authDone=true; try{unsub();}catch(e){} doRead(); }
    }, 5000);
  } catch(e){
    // No auth SDK
    doRead();
  }
}

function showAccountsError(msg){
  const list = document.getElementById('accountsList');
  if(list) list.innerHTML = `<div style="text-align:center;padding:24px;color:#ff6b6b;font-size:13px;">‚ùå ${msg}<br><br><span style="color:#5a6478;cursor:pointer;" onclick="loadAccounts(renderAccounts)">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</span></div>`;
}

// ‚îÄ‚îÄ Step 1: Render account list ‚îÄ‚îÄ
function renderAccounts(){
  const list = document.getElementById('accountsList');
  if(!list) return;
  const entries = Object.entries(_allAccounts);
  if(!entries.length){
    list.innerHTML = `<div style="text-align:center;padding:24px;color:#5a6478;font-size:13px;">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤.<br>–°–æ–∑–¥–∞–π—Ç–µ –∏—Ö –≤ –ø–∞–Ω–µ–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.</div>`;
    return;
  }
  list.innerHTML = entries.map(([accId, acc])=>`
    <div onclick="goToStep2('${accId}')"
      style="display:flex;align-items:center;gap:14px;background:#1e2330;border:1.5px solid rgba(255,255,255,0.07);border-radius:16px;padding:14px 18px;cursor:pointer;margin-bottom:10px;transition:all .2s;"
      onmouseover="this.style.borderColor='rgba(255,255,255,0.2)';this.style.background='#252d3d'"
      onmouseout="this.style.borderColor='rgba(255,255,255,0.07)';this.style.background='#1e2330'"
      ontouchstart="this.style.background='#252d3d'" ontouchend="this.style.background='#1e2330'">
      <div style="width:48px;height:48px;border-radius:14px;background:${acc.color};display:flex;align-items:center;justify-content:center;font-family:'Syne',sans-serif;font-weight:800;font-size:20px;color:#fff;flex-shrink:0;box-shadow:0 4px 14px ${acc.color}44;">${acc.name[0].toUpperCase()}</div>
      <div style="flex:1;">
        <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:15px;color:#fff;">${acc.name}</div>
        <div style="font-size:11px;color:#5a6478;margin-top:2px;">${Object.keys(acc.users||{}).length} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
      </div>
      <div style="font-size:18px;opacity:.25;">‚Ä∫</div>
    </div>
  `).join('');
}

// ‚îÄ‚îÄ Step 2: Show users for selected account ‚îÄ‚îÄ
function goToStep2(accId){
  _pendingAcc = { accId, accData: _allAccounts[accId] };
  const acc = _allAccounts[accId];
  // Update badge
  const av = document.getElementById('accBadgeAvatar');
  const nm = document.getElementById('accBadgeName');
  if(av){ av.textContent=acc.name[0].toUpperCase(); av.style.background=acc.color; }
  if(nm) nm.textContent = acc.name;
  // Render users
  const users = Object.entries(acc.users || {});
  const ul = document.getElementById('usersList');
  if(ul) ul.innerHTML = !users.length
    ? `<div style="text-align:center;color:#5a6478;padding:20px;font-size:13px;">–í –∞–∫–∫–∞—É–Ω—Ç–µ –Ω–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>`
    : users.map(([uid, u])=>`
      <div onclick="goToStep3('${uid}')"
        style="display:flex;align-items:center;gap:12px;background:#1e2330;border:1.5px solid rgba(255,255,255,0.07);border-radius:14px;padding:12px 16px;cursor:pointer;margin-bottom:8px;transition:all .2s;"
        onmouseover="this.style.borderColor='rgba(255,255,255,0.2)'"
        onmouseout="this.style.borderColor='rgba(255,255,255,0.07)'"
        ontouchstart="this.style.background='#252d3d'" ontouchend="this.style.background='#1e2330'">
        <div style="width:40px;height:40px;border-radius:12px;background:${u.color||'#6c8dfa'};display:flex;align-items:center;justify-content:center;font-family:'Syne',sans-serif;font-weight:800;font-size:16px;color:#fff;flex-shrink:0;">${(u.name||uid)[0].toUpperCase()}</div>
        <div style="flex:1;">
          <div style="font-weight:600;color:#fff;font-size:14px;">${u.name||uid}</div>
          <div style="font-size:11px;color:#5a6478;">${{admin:'–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä',editor:'–†–µ–¥–∞–∫—Ç–æ—Ä',viewer:'–ß–∏—Ç–∞—Ç–µ–ª—å'}[u.role]||'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</div>
        </div>
        <div style="font-size:16px;opacity:.25;">‚Ä∫</div>
      </div>
    `).join('');
  goToStep(2);
}

// ‚îÄ‚îÄ Step 3: Show password for selected user ‚îÄ‚îÄ
function goToStep3(userId){
  if(!_pendingAcc) return;
  const u = _pendingAcc.accData.users[userId];
  _pendingUser = { userId, userData: u };
  // Update user card
  const color = u.color || _pendingAcc.accData.color || '#6c8dfa';
  const av = document.getElementById('selUserAvatar');
  const nm = document.getElementById('selUserName');
  const mt = document.getElementById('selUserMeta');
  if(av){ av.textContent=(u.name||userId)[0].toUpperCase(); av.style.background=color; av.style.boxShadow=`0 4px 14px ${color}55`; }
  if(nm) nm.textContent = u.name || userId;
  if(mt) mt.textContent = _pendingAcc.accData.name + ' ¬∑ ' + ({admin:'–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä',editor:'–†–µ–¥–∞–∫—Ç–æ—Ä',viewer:'–ß–∏—Ç–∞—Ç–µ–ª—å'}[u.role]||'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å');
  document.getElementById('lockInput').value = '';
  document.getElementById('lockError').textContent = '';
  updatePinDots('');
  goToStep(3);
  // Always show input and focus ‚Äî works on both mobile and desktop
  document.getElementById('lockInputWrap').style.display = 'block';
  document.getElementById('lockTapArea').style.display   = 'none';
  // Slight delay so the step transition completes before focusing
  setTimeout(()=>{ try{ document.getElementById('lockInput').focus(); }catch(e){} }, 150);
}

// ‚îÄ‚îÄ Step navigation ‚îÄ‚îÄ
function goToStep(n){
  document.getElementById('stepAccounts').style.display = n===1 ? 'block' : 'none';
  document.getElementById('stepUsers').style.display    = n===2 ? 'block' : 'none';
  document.getElementById('stepPassword').style.display = n===3 ? 'block' : 'none';
}

// ‚îÄ‚îÄ Password check ‚îÄ‚îÄ
function checkPassword(){
  const input = document.getElementById('lockInput');
  const val   = input.value;
  if(!val){ document.getElementById('lockError').textContent = '–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å'; return; }
  if(!_pendingUser){ document.getElementById('lockError').textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è'; return; }

  // Allow local override (from showChangePassword)
  const localKey  = 'ffpro_'+_pendingAcc.accId+'_'+_pendingUser.userId+':ff_pass';
  const localPass = (()=>{ try{return localStorage.getItem(localKey);}catch(e){return null;} })();
  const correctPass = localPass || _pendingUser.userData.password || '';

  if(val === correctPass){
    const ls = document.getElementById('lockScreen');
    ls.style.transition = 'opacity .4s';
    ls.style.opacity = '0';
    setTimeout(()=>{
      ls.style.display='none'; ls.style.opacity=''; ls.style.transition='';
      startApp(_pendingAcc.accId, _pendingUser.userId, _pendingAcc.accData, _pendingUser.userData);
    }, 350);
  } else {
    input.value = '';
    updatePinDots('');
    document.getElementById('lockError').textContent = '‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å';
    const step = document.getElementById('stepPassword');
    step.style.animation = 'lockShake .35s ease';
    setTimeout(()=>{ step.style.animation=''; document.getElementById('lockError').textContent=''; }, 2000);
  }
}

function updatePinDots(val){
  const dots = document.getElementById('pinDots');
  if(!dots) return;
  const len = val.length;
  if(len===0){ dots.innerHTML=''; return; }
  const color = _pendingUser?.userData?.color || _pendingAcc?.accData?.color || '#6c8dfa';
  dots.innerHTML = Array.from({length:len}).map((_,i)=>
    `<div style="width:12px;height:12px;border-radius:50%;background:${color};animation:pinBounce .25s ease ${i===len-1?'0s':'none'} both;box-shadow:0 0 8px ${color}88;"></div>`
  ).join('');
  document.getElementById('lockError').textContent='';
}

function showChangePassword(){
  if(!_session.accId){ alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ'); return; }
  const localKey = STORE_PREFIX+'ff_pass';
  const localPass = (()=>{ try{return localStorage.getItem(localKey);}catch(e){return null;} })();
  const curPass = localPass || _session.userData.password || '';
  const cur = prompt(`–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å (${_session.userData.name||_session.userId}):`);
  if(cur !== curPass){ alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å'); return; }
  const np1 = prompt('–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å (–º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞):');
  if(!np1||np1.length<3){ alert('–ú–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞'); return; }
  const np2 = prompt('–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ:');
  if(np1!==np2){ alert('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç'); return; }
  store.set('ff_pass', np1);
  alert('‚úÖ –ü–∞—Ä–æ–ª—å –∏–∑–º–µ–Ω—ë–Ω! (—Ö—Ä–∞–Ω–∏—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ)');
}

// ‚îÄ‚îÄ Session check on startup ‚îÄ‚îÄ
function checkSession(){
  const savedAcc  = (()=>{ try{return sessionStorage.getItem('ffpro_active_acc');}catch(e){return null;} })();
  const savedUser = (()=>{ try{return sessionStorage.getItem('ffpro_active_user');}catch(e){return null;} })();

  if(savedAcc && savedUser){
    const pfx  = 'ffpro_'+savedAcc+'_'+savedUser+':';
    const sess = (()=>{ try{return localStorage.getItem(pfx+'sess');}catch(e){return null;} })();
    const ver  = (()=>{ try{return localStorage.getItem(pfx+'sess_ver');}catch(e){return null;} })();
    if(ver===APP_VER && sess && sess!=='0'){
      const age = Date.now() - parseInt(sess);
      if(age < 24*60*60*1000){
        // Valid session ‚Äî but we need account data from Firebase first
        loadAccounts(()=>{
          const accData = _allAccounts[savedAcc];
          if(accData && accData.users && accData.users[savedUser]){
            const userData = accData.users[savedUser];
            const ls = document.getElementById('lockScreen');
            if(ls) ls.style.display='none';
            startApp(savedAcc, savedUser, accData, userData);
          } else {
            // Account/user no longer exists ‚Äî show login
            showLoginScreen();
          }
        });
        return true;
      }
    }
  }
  showLoginScreen();
  return false;
}

function showLoginScreen(){
  const ls = document.getElementById('lockScreen');
  if(ls) ls.style.display='flex';
  loadAccounts(renderAccounts);
}

function lockApp(){
  // Clear session
  if(_session.accId && _session.userId){
    try{ sessionStorage.setItem('ffpro_active_acc',''); }catch(e){}
    try{ sessionStorage.setItem('ffpro_active_user',''); }catch(e){}
    try{ localStorage.setItem(STORE_PREFIX+'sess','0'); }catch(e){}
  }
  // Disconnect Firebase
  if(fbRef){ try{fbRef.off();}catch(e){} fbRef=null; }
  fbConnected=false;

  // Reset state
  allExpenses=[]; budgets={}; cfg={};
  _session={accId:null,userId:null,userData:null,accData:null};
  _pendingAcc=null; _pendingUser=null;
  STORE_PREFIX='ff_none:';
  USERS={}; CATS=JSON.parse(JSON.stringify(DEFAULT_CATS));

  // Clear user switcher
  const sw=document.getElementById('userSwitcher');
  if(sw) sw.innerHTML='';

  // Remove user badge
  const badge = document.getElementById('userBadge');
  if(badge) badge.remove();

  // Show login
  goToStep(1);
  showLoginScreen();
  const ls = document.getElementById('lockScreen');
  ls.style.opacity='0'; ls.style.display='flex';
  requestAnimationFrame(()=>{ ls.style.transition='opacity .3s'; ls.style.opacity='1'; });
  setTimeout(()=>{ ls.style.transition=''; }, 350);
}

// ‚îÄ‚îÄ STARTUP ‚îÄ‚îÄ
// iOS touch fix
document.querySelectorAll('[onclick]').forEach(el=>{
  if(el.tagName!=='BUTTON'&&el.tagName!=='A'&&el.tagName!=='INPUT'){
    el.setAttribute('role','button'); el.setAttribute('tabindex','0');
  }
});
const _mo = new MutationObserver(muts=>{
  muts.forEach(m=>m.addedNodes.forEach(n=>{
    if(n.querySelectorAll) n.querySelectorAll('[onclick]').forEach(el=>{
      if(el.tagName!=='BUTTON'&&el.tagName!=='A'){ el.setAttribute('role','button'); }
    });
  }));
});
_mo.observe(document.body,{childList:true,subtree:true});

// Check session / show login
document.addEventListener('DOMContentLoaded', function(){ checkSession(); });
if(document.readyState !== 'loading') checkSession();
// Note: initEmojiPicker, renderCalendar etc. are called inside startApp()

</script><!-- EDIT CATEGORY MODAL -->
<div class="modal-overlay" id="editCatModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é <button class="modal-close" onclick="document.getElementById('editCatModal').classList.remove('open')">√ó</button></h2>
    <input type="hidden" id="editCatOldName">
    <input type="hidden" id="selectedEditEmoji" value="üè∑">
    <div class="form-group">
      <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
      <input class="form-input" id="editCatName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">–ò–∫–æ–Ω–∫–∞</label>
        <div style="position:relative">
          <button style="width:100%;height:46px;border-radius:12px;background:var(--surface);border:1.5px solid var(--border);font-size:22px;cursor:pointer;display:flex;align-items:center;justify-content:center;" onclick="toggleEditEmojiPicker(event)">
            <span id="editCatEmoji">üè∑</span>
          </button>
          <div class="emoji-picker" id="editEmojiPicker"></div>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">–¶–≤–µ—Ç</label>
        <input type="color" class="cp2" id="editCatColor" value="#6c8dfa" style="width:100%;height:46px;border-radius:12px;">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="document.getElementById('editCatModal').classList.remove('open')">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-primary" onclick="saveEditCat()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

</body>
</html>
